<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover"/>
    <title>Chat Master v17.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
    <style>
        :root { --bg: #03050a; --me: #1e293b; --you: #0f172a; --accent: #3b82f6; }
        .theme-romantic { --bg: #1a0505; --me: #451010; --you: #2d0a0a; --accent: #f43f5e; }
        .theme-chill { --bg: #0f172a; --me: #1e293b; --you: #334155; --accent: #0ea5e9; }
        .theme-midnight { --bg: #000000; --me: #111111; --you: #1a1a1a; --accent: #a855f7; }

        body { background: var(--bg); color: #f1f5f9; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; margin: 0; transition: 0.5s; }
        #chat-main { display: flex; flex-direction: column; height: 100%; max-width: 600px; margin: 0 auto; position: relative; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .bubble { max-width: 85%; padding: 12px 14px 28px 14px; font-size: 15px; border-radius: 20px; position: relative; border: 1px solid rgba(255,255,255,0.05); }
        .me { background: var(--me); align-self: flex-end; border-bottom-right-radius: 4px; }
        .you { background: var(--you); align-self: flex-start; border-bottom-left-radius: 4px; }
        .ts { position: absolute; bottom: 8px; right: 12px; font-size: 9px; opacity: 0.4; }
        
        .modal { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 5000; padding: 25px; overflow-y: auto; }
        .rec-active { color: #f43f5e !important; animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.5; } }
        #sidebar { transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 4000; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="theme-chill">

<div id="chat-main">
    <header class="p-4 border-b border-white/5 flex justify-between items-center bg-black/20 backdrop-blur-xl">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar(true)" class="text-xl">‚ò∞</button>
            <div>
                <div id="display-name" class="font-bold text-lg">Loading...</div>
                <div id="typing-status" class="text-[10px] text-blue-400 font-bold h-3 uppercase"></div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="startCall(false)" class="p-2 px-3 bg-white/5 rounded-full text-[10px] font-bold">VOICE</button>
            <button onclick="startCall(true)" class="p-2 px-3 bg-blue-600 rounded-full text-[10px] font-bold">VIDEO</button>
        </div>
    </header>

    <main id="messages" class="no-scrollbar"></main>

    <footer class="p-4 bg-black/40">
        <div id="reply-preview" class="hidden bg-blue-500/10 p-2 mb-2 rounded-lg border-l-4 border-blue-500 text-xs flex justify-between">
            <span id="reply-preview-text"></span>
            <button onclick="cancelReply()">√ó</button>
        </div>
        <form id="chat-form" class="flex items-center bg-white/5 rounded-full p-1 border border-white/10">
            <label class="p-3 opacity-50 cursor-pointer">üìé<input type="file" id="file-input" class="hidden" multiple onchange="handleFiles(this)"></label>
            <input id="msg-input" placeholder="Message..." class="flex-1 bg-transparent py-3 outline-none text-sm px-2">
            <button type="button" id="voice-btn" class="p-3 text-xl">üéôÔ∏è</button>
            <button type="submit" class="bg-blue-600 px-6 py-3 rounded-full text-[10px] font-bold">SEND</button>
        </form>
        <div id="staged-previews" class="flex gap-2 mt-2"></div>
    </footer>
</div>

<div id="sidebar" class="fixed left-[-300px] top-0 bottom-0 w-[280px] bg-[#05070a] p-6 border-r border-white/5 flex flex-col">
    <div class="bg-pink-600/10 rounded-3xl p-6 mb-6 text-center border border-pink-500/20">
        <h1 id="days-count" class="text-4xl font-black">0</h1>
        <p class="text-[10px] uppercase opacity-50 mt-1">Days Together</p>
    </div>

    <div class="space-y-4 overflow-y-auto flex-1">
        <button onclick="showVault()" class="w-full text-left p-4 bg-white/5 rounded-xl font-bold">‚≠ê Starred Vault</button>
        <button onclick="shareLoc()" class="w-full text-left p-4 bg-green-500/10 text-green-400 rounded-xl font-bold">üìç Send Location</button>
        
        <div class="p-4 bg-white/5 rounded-xl">
            <p class="text-[10px] font-bold opacity-40 uppercase mb-3">Themes</p>
            <div class="grid grid-cols-3 gap-2">
                <button onclick="setTheme('romantic')" class="h-10 bg-rose-900 rounded-lg">‚ù§Ô∏è</button>
                <button onclick="setTheme('chill')" class="h-10 bg-slate-800 rounded-lg">‚ùÑÔ∏è</button>
                <button onclick="setTheme('midnight')" class="h-10 bg-black rounded-lg border border-white/10">üåå</button>
            </div>
        </div>

        <div id="rj-only" class="hidden pt-4 border-t border-white/10 space-y-2">
            <p class="text-[10px] font-bold text-red-500 uppercase">RJ Admin</p>
            <button onclick="launchPip()" class="w-full bg-blue-600 p-3 rounded-xl text-[10px] font-bold">LAUNCH PiP</button>
        </div>
    </div>
</div>

<div id="vault-modal" class="modal">
    <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold">Vault</h2><button onclick="closeModal('vault-modal')">CLOSE</button></div>
    <div id="vault-list" class="space-y-4"></div>
</div>

<div id="overlay" onclick="toggleSidebar(false)" class="hidden fixed inset-0 bg-black/80 z-[3000]"></div>

<script>
    const SB_URL = 'https://jwfgaulakwiwextmqbov.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3ZmdhdWxha3dpd2V4dG1xYm92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NzU1MTYsImV4cCI6MjA4MjI1MTUxNn0.DBOoI_wLNGyB1LLfXzyAbVvEkVMj9XcCJie-HAZ0_d4';
    const _db = supabase.createClient(SB_URL, SB_KEY);

    let me, you, channel, recorder, chunks = [], staged = [], replyId = null;
    let msgs = [];

    async function init() {
        const code = localStorage.getItem('chat_secret_code') || prompt("Access Code:");
        const { data: user, error } = await _db.from('chat_codes').select('*').eq('code', code).single();
        
        if(error || !user) {
            alert("Wrong code");
            localStorage.removeItem('chat_secret_code');
            return location.reload();
        }

        me = user.username; you = (me === 'RJ' ? 'Allyvia' : 'RJ');
        localStorage.setItem('chat_secret_code', code);
        document.getElementById('display-name').textContent = you;
        if(me === 'RJ') document.getElementById('rj-only').classList.remove('hidden');

        channel = _db.channel('chat-v17');
        channel.on('broadcast', { event: 'refresh' }, () => fetchMsgs())
               .on('broadcast', { event: 'theme' }, p => applyTheme(p.payload.t))
               .on('broadcast', { event: 'typing' }, p => {
                    document.getElementById('typing-status').textContent = p.payload.on ? `${you} is typing...` : "";
               }).subscribe();

        fetchMsgs();
        updateDays();
        setupVoice();
        
        // Instant Realtime
        _db.channel('db-changes').on('postgres_changes', { event: '*', schema: 'public', table: 'private_messages' }, () => fetchMsgs()).subscribe();
    }

    async function fetchMsgs() {
        const { data } = await _db.from('private_messages').select('*').order('created_at', { ascending: false }).limit(50);
        msgs = data.reverse();
        render();
    }

    function render() {
        const container = document.getElementById('messages');
        container.innerHTML = msgs.map(m => {
            const isMe = m.sender === me;
            const files = m.file_url ? m.file_url.split(',') : [];
            const media = files.map(u => u.includes('.webm') ? `<audio src="${u}" controls class="w-full mt-2"></audio>` : `<img src="${u}" class="rounded-lg mb-2 max-h-60 w-full object-cover">`).join('');
            
            return `<div class="msg-wrap ${isMe ? 'items-end' : 'items-start'} flex flex-col w-full">
                <div class="bubble ${isMe ? 'me' : 'you'}" ondblclick="starMsg('${m.id}')" onclick="setReply('${m.id}', '${(m.message || 'Media').substring(0,20)}')">
                    ${media}
                    <div class="whitespace-pre-wrap">${m.message || ''}</div>
                    <div class="ts">${new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                    ${m.reaction ? `<div class="reaction-tag">${m.reaction}</div>` : ''}
                </div>
            </div>`;
        }).join('');
        container.scrollTop = container.scrollHeight;
    }

    async function send() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if(!text && !staged.length) return;

        let urls = [];
        for(let f of staged) {
            const path = `uploads/${Date.now()}_${f.name}`;
            await _db.storage.from('chat-files').upload(path, f);
            urls.push(_db.storage.from('chat-files').getPublicUrl(path).data.publicUrl);
        }

        await _db.from('private_messages').insert([{
            sender: me, receiver: you, message: text, 
            file_url: urls.join(','), reply_to: replyId
        }]);

        input.value = ""; staged = []; replyId = null;
        document.getElementById('staged-previews').innerHTML = "";
        document.getElementById('reply-preview').classList.add('hidden');
        channel.send({ type: 'broadcast', event: 'refresh' });
        fetchMsgs();
    }

    function setupVoice() {
        const btn = document.getElementById('voice-btn');
        btn.onmousedown = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            recorder = new MediaRecorder(stream);
            chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = async () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                const path = `voice/${Date.now()}.webm`;
                await _db.storage.from('chat-files').upload(path, blob);
                const url = _db.storage.from('chat-files').getPublicUrl(path).data.publicUrl;
                await _db.from('private_messages').insert([{ sender: me, receiver: you, file_url: url }]);
                channel.send({ type: 'broadcast', event: 'refresh' });
            };
            recorder.start();
            btn.classList.add('rec-active');
        };
        btn.onmouseup = () => { recorder?.stop(); btn.classList.remove('rec-active'); };
    }

    async function starMsg(id) {
        const r = prompt("Star this message with a note/emoji:");
        if(!r) return;
        await _db.from('private_messages').update({ reaction: r, is_starred: true }).eq('id', id);
        fetchMsgs();
    }

    function setTheme(t) {
        applyTheme(t);
        channel.send({ type: 'broadcast', event: 'theme', payload: { t } });
        _db.from('chat_codes').update({ theme_pref: t }).eq('username', 'RJ');
    }
    function applyTheme(t) { document.body.className = `theme-${t}`; }

    function handleFiles(el) {
        staged = Array.from(el.files);
        document.getElementById('staged-previews').innerHTML = staged.map(f => `<div class="text-[10px] bg-white/10 px-2 py-1 rounded">üìé ${f.name.substring(0,10)}</div>`).join('');
    }

    function setReply(id, text) {
        replyId = id;
        document.getElementById('reply-preview-text').textContent = "Replying: " + text;
        document.getElementById('reply-preview').classList.remove('hidden');
    }
    function cancelReply() { replyId = null; document.getElementById('reply-preview').classList.add('hidden'); }

    function toggleSidebar(on) {
        document.getElementById('sidebar').style.left = on ? '0' : '-300px';
        document.getElementById('overlay').classList.toggle('hidden', !on);
    }

    async function showVault() {
        document.getElementById('vault-modal').style.display = 'block';
        const { data } = await _db.from('private_messages').select('*').eq('is_starred', true);
        document.getElementById('vault-list').innerHTML = data.map(m => `<div class="p-4 bg-white/5 rounded-xl border border-white/10"><p class="text-sm">${m.message || '[Media]'}</p><p class="text-[10px] text-pink-500 font-bold mt-2">‚≠ê ${m.reaction}</p></div>`).join('');
    }

    function shareLoc() {
        navigator.geolocation.getCurrentPosition(p => {
            const url = `https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`;
            document.getElementById('msg-input').value = "üìç My Location: " + url;
            send();
            toggleSidebar(false);
        });
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function updateDays() { document.getElementById('days-count').textContent = Math.floor((new Date() - new Date('2025-11-24')) / 86400000); }

    document.getElementById('chat-form').onsubmit = e => { e.preventDefault(); send(); };
    document.getElementById('msg-input').oninput = e => channel.send({ type: 'broadcast', event: 'typing', payload: { on: e.target.value.length > 0 } });

    init();
</script>
</body>
</html>
