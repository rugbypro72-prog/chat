<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover"/>
    <title>Chat Master v7.5</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
    
    <style>
        :root { 
            --bg: #020408; 
            --card: #0a0f1d; 
            --accent: #1d4ed8; 
            --text-main: #e2e8f0;
            --text-dim: #64748b;
        }

        body { 
            background: var(--bg); 
            color: var(--text-main); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh; 
            overflow: hidden; 
            margin: 0; 
        }

        /* Layout Structure */
        #chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 650px;
            margin: 0 auto;
            background: var(--bg);
            border-left: 1px solid #111827;
            border-right: 1px solid #111827;
            position: relative;
        }

        /* Header UI */
        header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(2, 4, 8, 0.8);
            backdrop-filter: blur(10px);
            z-index: 50;
        }

        /* Message Area */
        #messages-view {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        /* Bubble Styles */
        .message-row { display: flex; flex-direction: column; width: 100%; position: relative; }
        .row-right { align-items: flex-end; }
        .row-left { align-items: flex-start; }

        .bubble {
            max-width: 80%;
            padding: 12px 18px;
            font-size: 15px;
            line-height: 1.5;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
        }

        .bubble.sent { 
            background: #111827; 
            border: 1px solid #1e293b; 
            color: #ffffff; 
            border-bottom-right-radius: 4px; 
        }

        .bubble.received { 
            background: #1e293b; 
            color: #cbd5e1; 
            border-bottom-left-radius: 4px; 
        }

        /* Utilities & Interactivity */
        .msg-info {
            display: flex;
            gap: 10px;
            margin-top: 5px;
            font-size: 10px;
            color: var(--text-dim);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .message-row:hover .msg-info { opacity: 1; }

        .tools-btn { color: #3b82f6; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .tools-btn:hover { text-decoration: underline; }

        /* Sidebar & Navigation */
        #sidebar-menu {
            position: fixed;
            left: -320px;
            top: 0;
            bottom: 0;
            width: 300px;
            background: #05070a;
            z-index: 2000;
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            padding: 40px 25px;
            border-right: 1px solid #111827;
            box-shadow: 20px 0 50px rgba(0,0,0,0.5);
        }
        #sidebar-menu.active { transform: translateX(320px); }

        .sidebar-btn {
            width: 100%;
            text-align: left;
            padding: 14px;
            margin-bottom: 8px;
            border-radius: 10px;
            background: rgba(255,255,255,0.02);
            transition: 0.2s;
            font-weight: 500;
        }
        .sidebar-btn:hover { background: rgba(255,255,255,0.08); }

        /* Call Log List */
        #call-history {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-entry {
            font-size: 11px;
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-between;
            color: #94a3b8;
        }

        /* PiP Ghost */
        #pip-stream-source { position: absolute; left: -9999px; top: -9999px; }
    </style>
</head>
<body>

<video id="pip-dummy-player" autoplay muted playsinline></video>
<canvas id="pip-render-canvas" width="400" height="200" style="display:none;"></canvas>

<div id="sidebar-menu">
    <div class="mb-10 text-center">
        <h2 id="my-name-display" class="text-2xl font-bold text-white tracking-tight">RJ</h2>
        <p class="text-[10px] text-blue-500 uppercase font-bold tracking-widest mt-1">System Operator</p>
    </div>

    <nav class="space-y-2">
        <button class="sidebar-btn" onclick="toggleGallery()">üñºÔ∏è Gallery</button>
        
        <div id="rj-exclusive-zone" class="mt-6 pt-6 border-t border-white/10 hidden">
            <p class="text-[10px] text-gray-500 uppercase font-bold mb-4 tracking-tighter">Gaming Command</p>
            <button class="sidebar-btn border border-blue-600/30 text-blue-400" onclick="startPiPMode()">üöÄ Launch Pop-out Window</button>
            <button class="sidebar-btn border border-red-600/30 text-red-400" onclick="triggerSystemSnap()">üì∏ Capture Entire Screen</button>
        </div>
        
        <div class="mt-8">
            <p class="text-[10px] text-gray-500 uppercase font-bold mb-4 tracking-tighter">Call History</p>
            <div id="call-history"></div>
        </div>

        <button class="sidebar-btn opacity-40 mt-10" onclick="location.reload()">Force Restart</button>
    </nav>
</div>

<div id="chat-container">
    <header>
        <div class="flex items-center gap-4">
            <button onclick="toggleSidebar(true)" class="text-2xl opacity-70 hover:opacity-100 transition">‚ò∞</button>
            <div>
                <div class="flex items-center gap-2">
                    <h1 id="chat-partner-name" class="font-bold text-lg">Allyvia</h1>
                    <span id="header-timer" class="hidden text-[10px] bg-red-600 text-white px-2 py-0.5 rounded-full font-mono">00:00</span>
                </div>
                <div id="live-typing-preview" class="text-[11px] text-slate-500 italic h-4 truncate max-w-[180px]"></div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="startVoiceCall(false)" class="px-5 py-2 rounded-full bg-white/5 text-[10px] font-bold uppercase tracking-widest hover:bg-white/10 transition">Voice</button>
            <button onclick="startVoiceCall(true)" class="px-5 py-2 rounded-full bg-blue-600 text-[10px] font-bold uppercase tracking-widest shadow-lg shadow-blue-900/20 hover:bg-blue-500 transition">FaceTime</button>
        </div>
    </header>

    <main id="messages-view"></main>

    <footer class="p-4 bg-transparent">
        <div id="reply-context" class="hidden bg-blue-600/10 p-3 rounded-t-2xl border-l-4 border-blue-600 flex justify-between items-center mb-[-10px] pb-5">
            <span id="reply-label" class="text-xs text-blue-400 italic"></span>
            <button onclick="clearReply()" class="text-lg">&times;</button>
        </div>
        
        <form id="message-form" class="relative flex items-center bg-[#0a0f1d] border border-white/5 rounded-full p-1 pl-4">
            <label class="cursor-pointer opacity-40 hover:opacity-100 transition p-2">
                üìé <input type="file" class="hidden" id="image-upload" accept="image/*" onchange="handleFileUpload(event)">
            </label>
            <input type="text" id="main-input" placeholder="Message Allyvia..." autocomplete="off" 
                   class="flex-1 bg-transparent border-none outline-none py-4 px-2 text-sm"
                   oninput="syncLiveTyping(this.value)">
            <button type="submit" class="bg-blue-600 text-white font-bold px-6 py-3 rounded-full text-xs uppercase tracking-widest hover:scale-105 active:scale-95 transition">Send</button>
        </form>
    </footer>
</div>

<script>
    // --- DATABASE & AUTH ---
    const SB_URL = 'https://jwfgaulakwiwextmqbov.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3ZmdhdWxha3dpd2V4dG1xYm92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NzU1MTYsImV4cCI6MjA4MjI1MTUxNn0.DBOoI_wLNGyB1LLfXzyAbVvEkVMj9XcCJie-HAZ0_d4';
    const _client = supabase.createClient(SB_URL, SB_KEY);
    
    let userMe, userYou, activeReplyId = null, unreadCount = 0, lastReceivedMsg = "";
    let callTimerInterval, callStartTime;

    async function initializeApp() {
        const storedCode = localStorage.getItem('chat_secret_code') || prompt("Enter Access Code:");
        const { data: authData, error } = await _client.from('chat_codes').select('*').eq('code', storedCode).single();
        
        if (!authData) { alert("Invalid Code"); return; }
        
        localStorage.setItem('chat_secret_code', storedCode);
        userMe = authData.username;
        userYou = (userMe === 'RJ') ? 'Allyvia' : 'RJ';

        document.getElementById('my-name-display').textContent = userMe;
        document.getElementById('chat-partner-name').textContent = userYou;

        if (userMe === 'RJ') {
            document.getElementById('rj-exclusive-zone').classList.remove('hidden');
            renderPipFrame();
        }

        // --- REAL-TIME ENGINE ---
        _client.channel('main_room').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'private_messages' }, (payload) => {
            const newMsg = payload.new;
            if (newMsg.receiver === userMe) {
                if (newMsg.message.startsWith("___LIVE_PREVIEW___")) {
                    updateLiveTypingUI(newMsg.message.replace("___LIVE_PREVIEW___", ""));
                } else {
                    handleIncomingMessage(newMsg);
                }
            } else if (newMsg.sender === userMe && !newMsg.message.startsWith("___")) {
                loadMessages();
            }
        }).subscribe();

        loadMessages();
        loadLocalCallLogs();
    }

    // --- MESSAGE CORE ---
    async function loadMessages() {
        const { data, error } = await _client.from('private_messages')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(40);

        const view = document.getElementById('messages-view');
        const filtered = data.reverse().filter(m => !m.message.startsWith("___"));
        
        view.innerHTML = filtered.map(m => {
            const isMe = m.sender === userMe;
            const time = new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            return `
                <div class="message-row ${isMe ? 'row-right' : 'row-left'}">
                    <div class="msg-info">
                        <span class="tools-btn" onclick="initiateReply('${m.id}', '${m.message}')">Reply</span>
                        ${isMe ? `<span class="tools-btn text-red-500" onclick="deleteMessage('${m.id}')">Delete</span>` : ''}
                    </div>
                    <div class="bubble ${isMe ? 'sent' : 'received'}">
                        ${m.file_url ? `<img src="${m.file_url}" class="rounded-lg mb-2 max-w-full cursor-pointer" onclick="window.open('${m.file_url}')">` : ''}
                        ${m.message || ''}
                    </div>
                    <span class="timestamp text-[9px] opacity-30 mt-1">${time}</span>
                </div>
            `;
        }).join('');
        view.scrollTop = view.scrollHeight;
    }

    async function handleIncomingMessage(msg) {
        unreadCount++;
        lastReceivedMsg = msg.message;
        updateLiveTypingUI(""); // Clear typing preview when message arrives
        if (userMe === 'RJ') renderPipFrame();
        loadMessages();
    }

    async function sendMessage(text, fileUrl = null) {
        const { error } = await _client.from('private_messages').insert([{
            sender: userMe,
            receiver: userYou,
            message: text,
            file_url: fileUrl,
            reply_to: activeReplyId
        }]);
        if (!error) {
            document.getElementById('main-input').value = "";
            clearReply();
            syncLiveTyping(""); // Clear her preview
            loadMessages();
        }
    }

    // --- LIVE PREVIEW (THE "RJ TYPING" FEATURE) ---
    let typeDebounce;
    function syncLiveTyping(val) {
        clearTimeout(typeDebounce);
        typeDebounce = setTimeout(async () => {
            await _client.from('private_messages').insert([{
                sender: userMe,
                receiver: userYou,
                message: "___LIVE_PREVIEW___" + val
            }]);
        }, 150);
    }

    function updateLiveTypingUI(text) {
        const el = document.getElementById('live-typing-preview');
        el.textContent = text ? `Typing: ${text}...` : "";
    }

    // --- SYSTEM SNAPSHOT (FULL SCREEN) ---
    async function triggerSystemSnap() {
        try {
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            const video = document.createElement('video');
            video.srcObject = stream;
            video.onloadedmetadata = async () => {
                video.play();
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                stream.getTracks().forEach(track => track.stop()); // Stop capture immediately
                
                canvas.toBlob(async (blob) => {
                    const fileName = `snap_${Date.now()}.png`;
                    const { data, error } = await _client.storage.from('chat-files').upload(fileName, blob);
                    if (data) {
                        const { data: urlData } = _client.storage.from('chat-files').getPublicUrl(fileName);
                        sendMessage("üñ•Ô∏è Full System Snapshot Sent", urlData.publicUrl);
                    }
                });
            };
        } catch (err) { console.warn("Snap canceled by user"); }
    }

    // --- PIP GAMING MODE ---
    function renderPipFrame() {
        const canvas = document.getElementById('pip-render-canvas');
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#0a0f1d';
        ctx.fillRect(0,0,400,200);
        
        // Header
        ctx.fillStyle = unreadCount > 0 ? '#ef4444' : '#3b82f6';
        ctx.font = 'bold 26px Arial';
        ctx.fillText(`Allyvia ${unreadCount > 0 ? '(' + unreadCount + ')' : ''}`, 20, 50);
        
        // Message Body
        ctx.fillStyle = '#ffffff';
        ctx.font = '18px Arial';
        const displayTxt = lastReceivedMsg || "No new messages";
        ctx.fillText(displayTxt.substring(0, 38) + (displayTxt.length > 38 ? '...' : ''), 20, 100);
        
        const video = document.getElementById('pip-dummy-player');
        if (!video.srcObject) video.srcObject = canvas.captureStream();
    }

    async function startPiPMode() {
        unreadCount = 0;
        renderPipFrame();
        try {
            await document.getElementById('pip-dummy-player').requestPictureInPicture();
        } catch (e) { alert("PiP is not supported or blocked."); }
    }

    // --- CALLS & LOGS ---
    function startVoiceCall(video = false) {
        callStartTime = Date.now();
        document.getElementById('header-timer').classList.remove('hidden');
        callTimerInterval = setInterval(updateCallTimer, 1000);
        alert(`Connecting ${video ? 'FaceTime' : 'Voice'} to ${userYou}...`);
    }

    function updateCallTimer() {
        const diff = Math.floor((Date.now() - callStartTime) / 1000);
        const m = Math.floor(diff / 60).toString().padStart(2, '0');
        const s = (diff % 60).toString().padStart(2, '0');
        document.getElementById('header-timer').textContent = `${m}:${s}`;
    }

    function saveCallToLog(type, duration) {
        const logs = JSON.parse(localStorage.getItem('rj_call_logs') || '[]');
        logs.unshift({ type, duration, time: new Date().toLocaleTimeString() });
        localStorage.setItem('rj_call_logs', JSON.stringify(logs.slice(0, 15)));
        loadLocalCallLogs();
    }

    function loadLocalCallLogs() {
        const logs = JSON.parse(localStorage.getItem('rj_call_logs') || '[]');
        const container = document.getElementById('call-history');
        if (logs.length === 0) { container.innerHTML = '<p class="text-[10px] opacity-30">No calls today</p>'; return; }
        container.innerHTML = logs.map(l => `
            <div class="log-entry">
                <span>${l.type}</span>
                <span>${l.time}</span>
            </div>
        `).join('');
    }

    // --- UI HELPERS ---
    function toggleSidebar(show) {
        document.getElementById('sidebar-menu').classList.toggle('active', show);
    }

    function initiateReply(id, text) {
        activeReplyId = id;
        document.getElementById('reply-label').textContent = `Replying to: "${text.substring(0, 25)}..."`;
        document.getElementById('reply-context').classList.remove('hidden');
    }

    function clearReply() {
        activeReplyId = null;
        document.getElementById('reply-context').classList.add('hidden');
    }

    window.deleteMessage = async (id) => {
        if (confirm("Delete this message for everyone?")) {
            await _client.from('private_messages').delete().eq('id', id);
        }
    }

    document.getElementById('message-form').onsubmit = (e) => {
        e.preventDefault();
        const val = document.getElementById('main-input').value;
        if (val.trim()) sendMessage(val);
    };

    initializeApp();
</script>
</body>
</html>
