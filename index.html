<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover"/>
    <title>MidNight v3.0 Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
    <style>
        /* --- THEME VARIABLES --- */
        :root { 
            --bg: #03050a; --me-bg: #1e293b; --you-bg: #0f172a; 
            --accent: #3b82f6; --text: #f1f5f9; --sidebar-bg: #080c14;
            --msg-border: rgba(255,255,255,0.1);
        }
        body.theme-love {
            --bg: #1a0b12; --me-bg: #5c1e3a; --you-bg: #361121; 
            --accent: #ec4899; --sidebar-bg: #260f19;
             --msg-border: rgba(236, 72, 153, 0.3);
        }
        body { 
            background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; 
            height: 100vh; overflow: hidden; margin: 0; transition: background-color 0.5s ease;
            background-size: cover; background-position: center; background-attachment: fixed;
        }

        /* --- LAYOUT --- */
        #chat-main { display: flex; flex-direction: column; height: 100%; max-width: 600px; margin: 0 auto; position: relative; z-index: 10; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; scroll-behavior: smooth; }
        
        /* Message Styles */
        .avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid var(--msg-border); }
        .msg-wrap { display: flex; gap: 10px; width: 100%; position: relative; align-items: flex-end; }
        .row-me { flex-direction: row-reverse; } 
        
        .bubble { max-width: 80%; padding: 12px 14px 26px 14px; font-size: 15px; border-radius: 20px; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.1); word-wrap: break-word; transition: background 0.3s ease; }
        .me { background: var(--me-bg); border: 1px solid var(--msg-border); border-bottom-right-radius: 4px; }
        .you { background: var(--you-bg); border: 1px solid var(--msg-border); border-bottom-left-radius: 4px; }
        
        .ts-inside { position: absolute; bottom: 6px; right: 12px; font-size: 9px; opacity: 0.6; font-weight: 700; display: flex; align-items: center; gap: 4px; }
        .system-msg { width: 100%; text-align: center; font-size: 11px; color: #888; font-style: italic; margin: 10px 0; opacity: 0.7; }
        
        /* Reply Context */
        .reply-preview { font-size: 11px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 12px; border-left: 3px solid var(--accent); margin-bottom: 8px; opacity: 0.9; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .story-context { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 10px; margin-bottom: 8px; cursor: pointer; }
        .story-context img { width: 30px; height: 30px; border-radius: 6px; object-fit: cover; }

        /* --- STORY OVERLAY --- */
        #story-overlay { display: none; position: fixed; inset: 0; background: black; z-index: 6000; align-items: center; justify-content: center; flex-direction: column; }
        .story-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); font-size: 3rem; color: white; padding: 20px; cursor: pointer; opacity: 0.6; z-index: 6010; }
        #story-prev { left: 0; } #story-next { right: 0; }
        
        /* Story Reply Bar (Permanent) */
        #story-reply-container { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); padding: 20px 10px 40px 10px; z-index: 6020; display: flex; flex-direction: column; gap: 10px; }
        .emoji-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 5px; }
        .emoji-btn { font-size: 28px; cursor: pointer; transition: transform 0.2s; }
        .emoji-btn:hover { transform: scale(1.3); }

        /* --- MODALS & VIDEO --- */
        .modal-view { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 2000; overflow-y: auto; padding: 25px; }
        #video-grid { position: fixed; inset: 0; background: black; z-index: 3000; display: none; }
        .call-btn { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); font-size: 20px; }
        .call-btn.active { background: var(--accent); }
    </style>
</head>
<body>

<div id="video-grid">
    <div id="remote-video" class="w-full h-full"></div>
    <div id="local-video" class="absolute top-6 right-6 w-32 h-48 bg-gray-900 border border-white/20 rounded-xl overflow-hidden shadow-2xl z-[3001]"></div>
    <div class="absolute bottom-10 left-0 right-0 flex justify-center gap-6 z-[3002]">
        <button id="btn-mute" onclick="toggleMute()" class="call-btn">üé§</button>
        <button id="btn-cam" onclick="toggleCam()" class="call-btn">üì∑</button>
        <button id="btn-screen" onclick="toggleScreenShare()" class="call-btn">üñ•Ô∏è</button>
        <button onclick="endCall()" class="call-btn !bg-red-600">üìû</button>
    </div>
</div>

<div id="story-overlay">
    <button onclick="closeStory()" class="absolute top-6 right-6 text-white/80 text-3xl z-[6030] hover:text-white">‚úï</button>
    <div id="story-prev" class="story-nav-btn hidden" onclick="navStory(-1)">‚Äπ</div>
    <div id="story-media-container" class="relative w-full h-full flex items-center justify-center pb-32"></div>
    <div class="absolute top-12 text-center w-full text-xl font-bold text-white z-[6010]" id="story-caption"></div>
    <div id="story-next" class="story-nav-btn hidden" onclick="navStory(1)">‚Ä∫</div>

    <div id="story-reply-container">
        <div class="emoji-bar">
            <span onclick="reactToStory('üî•')" class="emoji-btn">üî•</span>
            <span onclick="reactToStory('üòÇ')" class="emoji-btn">üòÇ</span>
            <span onclick="reactToStory('üòç')" class="emoji-btn">üòç</span>
            <span onclick="reactToStory('üò¢')" class="emoji-btn">üò¢</span>
            <span onclick="reactToStory('üëè')" class="emoji-btn">üëè</span>
        </div>
        <form onsubmit="event.preventDefault(); replyToStory(this.querySelector('input').value); this.reset();" class="flex gap-2 max-w-md mx-auto w-full">
            <input type="text" placeholder="Reply to story..." class="flex-1 bg-white/20 border border-white/10 rounded-full px-4 py-3 text-white placeholder-white/60 outline-none backdrop-blur-md">
            <button type="submit" class="bg-blue-600 rounded-full w-12 h-12 flex items-center justify-center text-white">‚û§</button>
        </form>
    </div>
</div>

<div id="logs-modal" class="modal-view">
    <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-red-500">Deleted Logs</h2><button onclick="document.getElementById('logs-modal').style.display='none'" class="bg-white/10 px-4 py-1 rounded-full text-xs">Close</button></div>
    <div id="logs-content" class="space-y-4 pb-20"></div>
</div>
<div id="edits-modal" class="modal-view">
    <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-yellow-500">Edit Logs</h2><button onclick="document.getElementById('edits-modal').style.display='none'" class="bg-white/10 px-4 py-1 rounded-full text-xs">Close</button></div>
    <div id="edits-content" class="space-y-4 pb-20"></div>
</div>
<div id="story-history-modal" class="modal-view">
    <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-pink-500">Story Archive</h2><button onclick="document.getElementById('story-history-modal').style.display='none'" class="bg-white/10 px-4 py-1 rounded-full text-xs">Close</button></div>
    <div id="story-history-content" class="grid grid-cols-2 gap-3 pb-20"></div>
</div>

<div id="chat-main">
    <header class="p-4 border-b border-white/5 flex items-center justify-between bg-black/20 backdrop-blur-md z-50">
        <div class="flex items-center gap-3">
            <button onclick="openSidebar()" class="text-2xl">‚ò∞</button>
            <div class="relative cursor-pointer" onclick="handleStatusClick()">
                <img id="header-pfp" class="avatar" src="">
                <div id="status-ring" class="absolute inset-0 rounded-full border-2 border-blue-500 animate-pulse hidden"></div>
            </div>
            <div>
                <div class="font-bold text-md leading-none" id="partner-name">...</div>
                <div id="partner-status" class="text-[11px] opacity-70 mt-1 max-w-[200px] truncate"></div>
                <div id="typing-indicator" class="text-[10px] text-[var(--accent)] italic h-3 overflow-hidden font-bold"></div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="initCall(false)" class="p-2 bg-white/10 rounded-full text-[10px]">üìû</button>
            <button onclick="initCall(true)" class="p-2 bg-blue-600 rounded-full text-[10px]">üé•</button>
        </div>
    </header>

    <main id="messages"></main>

    <footer class="p-4">
        <div id="staging-area" class="grid grid-cols-4 gap-2 mb-2 empty:hidden"></div>
        <div id="reply-box" class="hidden bg-blue-500/10 p-3 rounded-t-2xl border-l-4 border-blue-600 flex justify-between items-center mb-[-10px] pb-5">
            <span id="reply-text" class="text-[11px] italic truncate pr-4"></span>
            <button onclick="cancelReply()">‚úï</button>
        </div>
        <div id="edit-box" class="hidden bg-yellow-500/10 p-3 rounded-t-2xl border-l-4 border-yellow-600 flex justify-between items-center mb-[-10px] pb-5">
            <span class="text-[11px] text-yellow-300 italic">Editing...</span>
            <button onclick="cancelEdit()">‚úï</button>
        </div>
        <form id="chat-form" class="flex items-center bg-black/40 border border-white/10 rounded-full p-1 pl-4 shadow-2xl backdrop-blur-md">
            <label class="cursor-pointer opacity-50 p-2">üìé<input type="file" id="file-input" class="hidden" multiple accept="image/*" onchange="handleFileSelect(this)"></label>
            <input id="msg-input" placeholder="Message..." autocomplete="off" class="flex-1 bg-transparent py-3 px-2 text-sm outline-none">
            <button type="submit" id="send-btn" class="bg-blue-600 text-white font-bold px-6 py-3 rounded-full text-[10px]">SEND</button>
        </form>
    </footer>
</div>

<div id="sidebar" class="fixed left-[-300px] top-0 bottom-0 w-[280px] bg-[var(--sidebar-bg)] z-[1000] p-6 flex flex-col transition-all duration-300 border-r border-white/10">
    <div class="mb-6 text-center">
        <h1 class="text-[var(--accent)] font-black text-2xl">MidNight</h1>
        <div class="flex flex-col items-center mt-6">
            <div class="relative group">
                <img id="my-pfp" class="w-24 h-24 rounded-full border-4 border-white/10 object-cover">
                <label class="absolute inset-0 flex items-center justify-center bg-black/60 rounded-full opacity-0 group-hover:opacity-100 cursor-pointer transition">
                    <span class="text-xs font-bold">CHANGE</span>
                    <input type="file" class="hidden" accept="image/*" onchange="uploadPFP(this)">
                </label>
            </div>
            <p id="me-name" class="font-bold mt-3 text-lg"></p>
        </div>
    </div>

    <div class="flex-1 space-y-4 overflow-y-auto">
        <div class="bg-white/5 p-4 rounded-2xl space-y-3">
            <p class="text-[10px] font-bold opacity-40 uppercase">Update Story</p>
            <input id="status-txt-input" placeholder="Caption..." class="w-full bg-black/40 p-2 rounded-lg text-xs outline-none border border-white/5">
            <label class="block bg-white/5 p-2 rounded-lg text-[10px] text-center cursor-pointer border border-dashed border-white/20">üì∏ Add Media <input type="file" id="status-media-input" class="hidden" multiple accept="image/*,video/*"></label>
            <div class="flex gap-2">
                <button onclick="updateStatus()" class="flex-1 bg-blue-600 p-2 rounded text-[10px] font-bold">POST</button>
                <button onclick="clearStatus()" class="bg-red-600/20 text-red-500 p-2 rounded text-[10px]">üóë</button>
            </div>
        </div>

        <div class="bg-white/5 p-4 rounded-2xl space-y-2">
            <p class="text-[10px] font-bold opacity-40 uppercase">Themes (Mutual)</p>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="setTheme('default')" class="text-[10px] p-2 bg-slate-800 rounded">DARK</button>
                <button onclick="setTheme('love')" class="text-[10px] p-2 bg-pink-900 rounded">LOVE</button>
            </div>
        </div>
        
        <div id="admin-panel" class="hidden space-y-2">
            <p class="text-[10px] font-bold opacity-40 uppercase mt-4">Admin Logs</p>
            <div class="grid grid-cols-3 gap-2">
                <button onclick="viewStoryLogs()" class="p-2 bg-pink-900/30 text-pink-400 rounded text-[10px]">Stories</button>
                <button onclick="viewEditLogs()" class="p-2 bg-yellow-900/30 text-yellow-400 rounded text-[10px]">Edits</button>
                <button onclick="viewDeletedLogs()" class="p-2 bg-red-900/30 text-red-400 rounded text-[10px]">Deleted</button>
            </div>
        </div>
    </div>
</div>
<div id="overlay-bg" onclick="closeSidebar()" class="hidden fixed inset-0 bg-black/80 backdrop-blur-md z-[900]"></div>

<script>
    // --- SUPABASE SETUP ---
    const SB_URL = 'https://jwfgaulakwiwextmqbov.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3ZmdhdWxha3dpd2V4dG1xYm92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NzU1MTYsImV4cCI6MjA4MjI1MTUxNn0.DBOoI_wLNGyB1LLfXzyAbVvEkVMj9XcCJie-HAZ0_d4';
    const _db = supabase.createClient(SB_URL, SB_KEY);
    
    // --- STATE ---
    let me, you, channel, allMessages = [], storyItems = [], storyIndex = 0, partnerData = null, chatCode;
    let replyId = null, editingId = null, stagedFiles = [], typingTimer = null;
    let rtc = { client: null, localAudio: null, localVideo: null, screen: null, sharing: false };
    
    // --- INIT ---
    async function init() {
        chatCode = localStorage.getItem('chat_secret_code') || prompt("Enter Access Code:");
        const { data } = await _db.from('chat_codes').select('*').eq('code', chatCode).single();
        
        if(!data) { alert("Invalid Code"); return; }
        localStorage.setItem('chat_secret_code', chatCode);
        me = data.username;
        you = (me === 'RJ' ? 'Allyvia' : 'RJ');
        
        document.getElementById('me-name').textContent = me;
        document.getElementById('partner-name').textContent = you;
        if(me === 'RJ') document.getElementById('admin-panel').classList.remove('hidden');

        // Realtime Subscription
        channel = _db.channel('midnight-main');
        channel
            .on('broadcast', { event: 'typing' }, p => handleTyping(p.payload))
            .on('postgres_changes', { event: '*', schema: 'public', table: 'private_messages' }, () => loadMessages())
            .on('postgres_changes', { event: '*', schema: 'public', table: 'chat_codes' }, () => syncConfigs())
            .subscribe();

        syncConfigs();
        loadMessages();
    }

    // --- TYPING LOGIC (FIXED) ---
    document.getElementById('msg-input').onkeyup = () => {
        const payload = (me === 'Allyvia') 
            ? { user: me, text: document.getElementById('msg-input').value } // RJ sees text
            : { user: me }; // Allyvia just sees "RJ is typing"
        channel.send({ type: 'broadcast', event: 'typing', payload });
    };

    function handleTyping(p) {
        const ind = document.getElementById('typing-indicator');
        clearTimeout(typingTimer);
        
        if (p.user !== me) {
            // Logic: If sender is Allyvia and I am RJ -> Show Text. Else -> Generic
            if (p.user === 'Allyvia' && me === 'RJ') {
                ind.textContent = `Allyvia is typing: ${p.text || '...'}`;
            } else {
                ind.textContent = `${p.user} is typing...`;
            }
        }
        
        typingTimer = setTimeout(() => { ind.textContent = ''; }, 3000);
    }

    // --- SYNC CONFIGS (THEMES & PFP) ---
    async function syncConfigs() {
        const { data } = await _db.from('chat_codes').select('*').eq('code', chatCode);
        const myD = data.find(u => u.username === me);
        const youD = data.find(u => u.username === you);
        partnerData = youD;

        // Mutual Theme
        document.body.className = `theme-${myD.current_theme || 'default'}`;
        
        // PFPs (Cache Busting)
        const ts = new Date().getTime();
        document.getElementById('my-pfp').src = myD.pfp_url ? `${myD.pfp_url}?t=${ts}` : `https://ui-avatars.com/api/?name=${me}`;
        document.getElementById('header-pfp').src = youD.pfp_url ? `${youD.pfp_url}?t=${ts}` : `https://ui-avatars.com/api/?name=${you}`;
        
        // Status
        document.getElementById('partner-status').textContent = youD.status_text || "No status";
        document.getElementById('status-ring').classList.toggle('hidden', !(youD.story_items?.length > 0));
    }

    async function setTheme(t) {
        // Update DB so it changes for BOTH people
        await _db.from('chat_codes').update({ current_theme: t }).eq('code', chatCode);
        await sendSystemMsg(`${me} set the theme to ${t}`);
    }

    async function uploadPFP(input) {
        if(!input.files[0]) return;
        const file = input.files[0];
        const name = `pfp_${me}_${Date.now()}`;
        await _db.storage.from('chat-files').upload(name, file);
        const url = _db.storage.from('chat-files').getPublicUrl(name).data.publicUrl;
        
        await _db.from('chat_codes').update({ pfp_url: url }).eq('username', me);
        // Force refresh immediately for self
        document.getElementById('my-pfp').src = url;
    }

    // --- MESSAGING ---
    async function loadMessages() {
        const { data } = await _db.from('private_messages').select('*').order('created_at', { ascending: false }).limit(100);
        allMessages = data.reverse();
        renderMessages();
    }

    async function sendSystemMsg(txt) {
        await _db.from('private_messages').insert([{ sender: 'System', receiver: 'All', message: txt, is_read: true }]);
    }

    function renderMessages() {
        const container = document.getElementById('messages');
        container.innerHTML = allMessages.map(m => {
            if(m.sender === 'System') return `<div class="system-msg">${m.message}</div>`;
            
            const isMe = m.sender === me;
            const pfp = isMe ? document.getElementById('my-pfp').src : document.getElementById('header-pfp').src;
            
            // Reply content
            let replyHtml = '';
            if(m.reply_to) {
                const parent = allMessages.find(x => x.id === m.reply_to);
                replyHtml = `<div class="reply-preview">${parent ? (parent.message || 'Media') : 'Message deleted'}</div>`;
            }
            if(m.story_reply_url) {
                replyHtml += `<div class="story-context" onclick="openStorySingle('${m.story_reply_url}')"><img src="${m.story_reply_url}"><span>Replying to story</span></div>`;
            }

            // Buttons: Reply (Everyone), Edit/Delete (Me Only)
            const btns = `
            <div class="absolute -bottom-5 ${isMe ? 'right-2' : 'left-2'} flex gap-3 opacity-0 group-hover:opacity-100 transition-opacity p-1 bg-black/60 rounded-full z-20">
                <button onclick="startReply('${m.id}', '${(m.message || 'Media').replace(/'/g, "\\'")}')" class="text-[9px] text-blue-400 font-bold px-2">REPLY</button>
                ${isMe ? `
                <button onclick="startEdit('${m.id}', '${(m.message||"").replace(/'/g, "\\'")}')" class="text-[9px] text-yellow-400 font-bold px-2">EDIT</button>
                <button onclick="deleteMsg('${m.id}', '${(m.message||"").replace(/'/g, "\\'")}', '${m.file_url||""}')" class="text-[9px] text-red-400 font-bold px-2">DEL</button>
                ` : ''}
            </div>`;

            // Media
            let media = m.file_url ? m.file_url.split(',').map(u => `<img src="${u}" class="max-h-60 rounded-lg mb-2 cursor-pointer" onclick="openStorySingle('${u}')">`).join('') : '';

            return `
            <div class="msg-wrap ${isMe ? 'row-me' : ''} group">
                <img src="${pfp}" class="avatar">
                <div class="bubble ${isMe ? 'me' : 'you'}">
                    ${replyHtml} ${media}
                    <div>${m.message || ''}</div>
                    <span class="ts-inside">${m.edited ? '(edited)' : ''} ${new Date(m.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
                </div>
                ${btns}
            </div>`;
        }).join('');
        container.scrollTop = container.scrollHeight;
    }

    // --- ACTIONS ---
    function startReply(id, txt) {
        replyId = id;
        document.getElementById('reply-box').classList.remove('hidden');
        document.getElementById('reply-text').textContent = `Replying to: ${txt}`;
        document.getElementById('msg-input').focus();
    }
    function cancelReply() { replyId = null; document.getElementById('reply-box').classList.add('hidden'); }

    function startEdit(id, txt) {
        editingId = id;
        document.getElementById('edit-box').classList.remove('hidden');
        document.getElementById('msg-input').value = txt;
        document.getElementById('send-btn').textContent = "SAVE";
    }
    function cancelEdit() {
        editingId = null; document.getElementById('edit-box').classList.add('hidden');
        document.getElementById('msg-input').value = ''; document.getElementById('send-btn').textContent = "SEND";
    }

    async function deleteMsg(id, txt, fileUrl) {
        if(!confirm("Delete this?")) return;
        // 1. Log IT FIRST (Realtime for RJ)
        await _db.from('deleted_logs').insert([{ original_sender: me, content: txt, file_url: fileUrl }]);
        // 2. Then Delete
        await _db.from('private_messages').delete().eq('id', id);
    }

    // --- STORIES ---
    async function updateStatus() {
        const txt = document.getElementById('status-txt-input').value;
        const files = document.getElementById('status-media-input').files;
        let items = [];
        
        for(let f of files) {
            const name = `story_${Date.now()}_${Math.random()}`;
            await _db.storage.from('chat-files').upload(name, f);
            items.push({ 
                url: _db.storage.from('chat-files').getPublicUrl(name).data.publicUrl, 
                type: f.type.startsWith('video') ? 'video' : 'image' 
            });
        }
        
        // Update DB
        await _db.from('chat_codes').update({ status_text: txt, story_items: items }).eq('username', me);
        // Log History
        await _db.from('story_history').insert([{ username: me, status_text: txt, story_items: items }]);
        // Notify
        await sendSystemMsg(`${me} uploaded a new story`);
        
        closeSidebar();
    }

    function handleStatusClick() {
        if(partnerData?.story_items?.length) openStoryViewer(partnerData.story_items, partnerData.status_text);
    }
    function openStoryViewer(items, caption) {
        storyItems = items; storyIndex = 0;
        document.getElementById('story-caption').textContent = caption || '';
        document.getElementById('story-overlay').style.display = 'flex';
        renderStoryItem();
    }
    function renderStoryItem() {
        const item = storyItems[storyIndex];
        const con = document.getElementById('story-media-container');
        document.getElementById('story-prev').classList.toggle('hidden', storyIndex===0);
        document.getElementById('story-next').classList.toggle('hidden', storyIndex===storyItems.length-1);
        
        con.innerHTML = item.type === 'video' 
            ? `<video src="${item.url}" autoplay controls class="max-h-[70vh] max-w-full rounded-xl"></video>`
            : `<img src="${item.url}" class="max-h-[70vh] max-w-full rounded-xl">`;
    }
    function navStory(dir) { storyIndex += dir; renderStoryItem(); }
    function closeStory() { document.getElementById('story-overlay').style.display='none'; }
    function openStorySingle(u) { openStoryViewer([{url:u, type:'image'}]); document.getElementById('story-reply-container').style.display='none'; }

    async function replyToStory(txt) {
        if(!txt) return;
        const url = storyItems[storyIndex].url;
        await _db.from('private_messages').insert([{ 
            sender: me, receiver: you, message: txt, story_reply_url: url 
        }]);
        closeStory();
    }
    function reactToStory(emoji) { replyToStory(emoji); }

    // --- ADMIN LOGS ---
    async function viewDeletedLogs() {
        if(me !== 'RJ') return;
        const { data } = await _db.from('deleted_logs').select('*').order('created_at', {ascending:false}).limit(20);
        document.getElementById('logs-content').innerHTML = data.map(l => `<div class="bg-white/5 p-2 rounded text-sm"><b class="text-red-400">${l.original_sender}</b>: ${l.content || ''} ${l.file_url?'(Media)':''}</div>`).join('');
        document.getElementById('logs-modal').style.display = 'block';
    }
    async function viewEditLogs() {
         // Requires 'original_message' column in private_messages tracking updates, simple fetch here
         alert("To view edits, ensure your private_messages table tracks version history or use a separate edits table similar to deleted_logs.");
    }
    async function viewStoryLogs() {
        if(me !== 'RJ') return;
        const { data } = await _db.from('story_history').select('*').order('created_at', {ascending:false}).limit(20);
        document.getElementById('story-history-content').innerHTML = data.map(s => `<div class="bg-white/5 p-2 rounded text-sm"><b class="text-pink-400">${s.username}</b><br>${s.status_text || 'No Caption'}<br><span class="text-xs opacity-50">${new Date(s.created_at).toLocaleString()}</span></div>`).join('');
        document.getElementById('story-history-modal').style.display = 'block';
    }

    // --- CALLING (AGORA) ---
    async function initCall(video) {
        rtc.client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
        await rtc.client.join("4f6c6c2002784152a8366dec12f1b4c0", "main", null, null);
        
        rtc.localAudio = await AgoraRTC.createMicrophoneAudioTrack();
        if(video) {
            rtc.localVideo = await AgoraRTC.createCameraVideoTrack();
            rtc.localVideo.play("local-video");
            await rtc.client.publish([rtc.localAudio, rtc.localVideo]);
        } else {
            await rtc.client.publish([rtc.localAudio]);
            document.getElementById('local-video').innerHTML = '<div class="w-full h-full flex items-center justify-center text-4xl">üéôÔ∏è</div>';
        }

        document.getElementById('video-grid').style.display = 'flex';
        
        rtc.client.on("user-published", async (user, mediaType) => {
            await rtc.client.subscribe(user, mediaType);
            if (mediaType === "video") user.videoTrack.play("remote-video");
            if (mediaType === "audio") user.audioTrack.play();
        });
    }

    function toggleMute() { rtc.localAudio.setEnabled(!rtc.localAudio.enabled); document.getElementById('btn-mute').classList.toggle('active'); }
    function toggleCam() { if(rtc.localVideo) { rtc.localVideo.setEnabled(!rtc.localVideo.enabled); document.getElementById('btn-cam').classList.toggle('active'); } }
    function endCall() { rtc.client.leave(); document.getElementById('video-grid').style.display='none'; location.reload(); } // simple cleanup

    // --- UTILS ---
    function openSidebar() { document.getElementById('sidebar').style.left = '0'; document.getElementById('overlay-bg').classList.remove('hidden'); }
    function closeSidebar() { document.getElementById('sidebar').style.left = '-300px'; document.getElementById('overlay-bg').classList.add('hidden'); }
    function handleFileSelect(inp) { 
        Array.from(inp.files).forEach(f => {
            const reader = new FileReader();
            reader.onload = e => stagedFiles.push({ file: f, preview: e.target.result }); 
            // In a real app, render preview here. For now we auto-attach.
            document.getElementById('send-btn').textContent = `SEND (${stagedFiles.length} FILES)`;
        }); 
    }

    // Send Handler
    document.getElementById('chat-form').onsubmit = async e => {
        e.preventDefault();
        const txt = document.getElementById('msg-input').value;
        
        if(editingId) {
            await _db.from('private_messages').update({ message: txt }).eq('id', editingId);
            cancelEdit(); return;
        }

        let fileUrls = [];
        if(stagedFiles.length) {
            for(let f of stagedFiles) {
                const n = `msg_${Date.now()}_${Math.random()}`;
                await _db.storage.from('chat-files').upload(n, f.file);
                fileUrls.push(_db.storage.from('chat-files').getPublicUrl(n).data.publicUrl);
            }
        }

        if(txt || fileUrls.length) {
            await _db.from('private_messages').insert([{
                sender: me, receiver: you, message: txt, file_url: fileUrls.join(','), reply_to: replyId
            }]);
            document.getElementById('msg-input').value = '';
            stagedFiles = []; cancelReply();
        }
    };
    
    init();
</script>
</body>
</html>
