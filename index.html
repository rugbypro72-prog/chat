<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
    <meta name="theme-color" content="#3b82f6"/>
    <title>Us v21 (Ultimate)</title>
    
    <!-- PWA Essentials -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #03050a;
            --sidebar-bg: #080c14;
            --msg-me: #3b82f6;
            --msg-you: #1e293b;
            --text-color: #f1f5f9;
            --accent: #3b82f6;
            --glass: rgba(20, 20, 25, 0.6);
            --border: rgba(255,255,255,0.05);
        }

        /* THEMES */
        [data-theme="midnight"] { --bg-color: #03050a; --sidebar-bg: #080c14; --msg-me: #2563eb; --msg-you: #1e293b; --accent: #3b82f6; }
        [data-theme="love"] { --bg-color: #1a0508; --sidebar-bg: #29080c; --msg-me: #e11d48; --msg-you: #2d0e14; --accent: #fb7185; }
        [data-theme="forest"] { --bg-color: #051a08; --sidebar-bg: #09260e; --msg-me: #16a34a; --msg-you: #0e2e18; --accent: #4ade80; }
        [data-theme="lavender"] { --bg-color: #0f051a; --sidebar-bg: #1a092e; --msg-me: #7c3aed; --msg-you: #201036; --accent: #a78bfa; }
        [data-theme="sunset"] { --bg-color: #1a0b0b; --sidebar-bg: #2d1215; --msg-me: #ea580c; --msg-you: #291515; --accent: #fb923c; }
        [data-theme="ocean"] { --bg-color: #081b26; --sidebar-bg: #0c2b3b; --msg-me: #0891b2; --msg-you: #0e3745; --accent: #22d3ee; }
        [data-theme="retro"] { --bg-color: #1c1917; --sidebar-bg: #292524; --msg-me: #d97706; --msg-you: #292524; --accent: #fcd34d; }
        [data-theme="custom"] { --bg-color: #000000; --sidebar-bg: rgba(0,0,0,0.8); --msg-me: rgba(59, 130, 246, 0.8); --msg-you: rgba(30, 41, 59, 0.7); --accent: #3b82f6; --glass: rgba(0, 0, 0, 0.4); }

        body { background: var(--bg-color); background-size: cover; background-position: center; background-attachment: fixed; color: var(--text-color); font-family: 'Outfit', sans-serif; height: 100dvh; overflow: hidden; margin: 0; transition: background-color 0.5s ease; }
        
        #chat-main { display: flex; flex-direction: column; height: 100dvh; max-width: 600px; margin: 0 auto; position: relative; z-index: 10; background: radial-gradient(circle at top, rgba(255,255,255,0.03), transparent 70%); backdrop-filter: blur(0px); }
        [data-theme="custom"] #chat-main { backdrop-filter: blur(5px); }

        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; padding-bottom: 80px; -webkit-overflow-scrolling: touch; will-change: scroll-position; }
        
        .msg-wrap { display: flex; flex-direction: column; width: 100%; position: relative; animation: slideIn 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; opacity: 0; transform: translateY(10px); }
        @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }
        
        .row-me { align-items: flex-end; } 
        .row-you { align-items: flex-start; }
        
        .bubble { max-width: 85%; padding: 12px 16px 26px 16px; font-size: 15px; border-radius: 20px; position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.1); word-wrap: break-word; line-height: 1.5; backdrop-filter: blur(5px); transition: transform 0.1s; }
        .bubble:active { transform: scale(0.98); }
        .me { background: var(--msg-me); color: white; border-bottom-right-radius: 4px; background: linear-gradient(135deg, var(--msg-me), var(--accent)); }
        .you { background: var(--msg-you); border: 1px solid rgba(255,255,255,0.05); border-bottom-left-radius: 4px; }
        .sending { opacity: 0.7; transform: scale(0.98); }
        
        /* MEDIA HANDLING */
        .bubble img, .bubble video { border-radius: 12px; margin-bottom: 6px; width: 100%; max-height: 300px; object-fit: cover; background: rgba(0,0,0,0.2); }
        .ts-inside { position: absolute; bottom: 6px; right: 12px; font-size: 9px; opacity: 0.7; font-weight: 600; display: flex; align-items: center; gap: 4px; }
        .reply-preview { font-size: 11px; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 12px; border-left: 3px solid rgba(255,255,255,0.5); margin-bottom: 6px; opacity: 0.9; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .msg-tools { opacity: 0; transition: 0.2s; display: flex; gap: 12px; margin-top: 4px; padding: 0 8px; transform: scale(0.9); }
        .msg-wrap:hover .msg-tools { opacity: 1; transform: scale(1); }
        .tool-btn { color: var(--accent); font-size: 10px; font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; }

        /* ANIMATIONS & MODALS */
        #partner-name.has-media { color: var(--accent) !important; text-decoration: underline; text-decoration-style: wavy; cursor: pointer; animation: statusPulse 2s infinite; }
        @keyframes statusPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .modal-view { display: none; position: fixed; inset: 0; background: var(--bg-color); z-index: 2000; overflow-y: auto; padding: 25px; }
        
        /* PIN LOCK & CANVAS */
        #pin-overlay { display: none; position: fixed; inset: 0; background: var(--bg-color); z-index: 9999; align-items: center; justify-content: center; flex-direction: column; }
        .pin-dot { width: 15px; height: 15px; border-radius: 50%; border: 2px solid var(--accent); margin: 0 5px; transition: 0.2s; }
        .pin-dot.filled { background: var(--accent); }
        .pin-key { width: 70px; height: 70px; border-radius: 50%; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; margin: 10px; cursor: pointer; transition: 0.2s; }
        .pin-key:active { background: var(--accent); color: white; }
        
        #whiteboard-modal { display: none; position: fixed; inset: 0; background: #000; z-index: 4000; flex-direction: column; }
        #canvas-container { flex: 1; position: relative; overflow: hidden; touch-action: none; background: #fff; }

        /* UI ELEMENTS */
        .glass-panel { background: var(--glass); backdrop-filter: blur(20px); border-top: 1px solid var(--border); }
        .input-pill { background: rgba(255,255,255,0.05); border: 1px solid var(--border); transition: 0.3s; }
        .input-pill:focus-within { background: rgba(255,255,255,0.1); border-color: var(--accent); }
        #sidebar { background: var(--sidebar-bg); border-right: 1px solid var(--border); }

        /* CALL UI */
        .call-btn { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.2s; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .call-btn:active { transform: scale(0.95); }
        .call-btn.active { background: #ef4444; color: white; } 
        .call-btn.screen-active { background: #3b82f6; color: white; }
        
        #video-grid { transition: opacity 0.3s ease; }
        #remote-video video { object-fit: contain !important; } 
        .video-cover video { object-fit: cover !important; }
        .recording-pulse { animation: pulseRed 1s infinite; color: #ef4444 !important; }
        @keyframes pulseRed { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* TOGGLE SWITCH */
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); }

        .theme-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.2s; position: relative; }
        .theme-dot.selected { border-color: white; transform: scale(1.1); }
        .theme-dot-custom { background: linear-gradient(45deg, #333, #999); display: flex; align-items: center; justify-content: center; font-size: 8px; color: white; font-weight: bold; }
    </style>
</head>
<body data-theme="midnight">

<div id="pin-overlay">
    <div class="mb-8 text-center">
        <h2 id="pin-title" class="text-2xl font-bold mb-2">Enter PIN</h2>
        <p id="pin-subtitle" class="text-xs opacity-50 uppercase tracking-widest">Secured</p>
        <div class="flex justify-center mt-4" id="pin-dots">
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        </div>
    </div>
    <div class="grid grid-cols-3 gap-4" id="numpad"></div>
    <button id="cancel-pin-setup" onclick="cancelPinSetup()" class="hidden mt-8 text-sm text-red-400 font-bold">CANCEL</button>
</div>

<div id="whiteboard-modal">
    <div class="p-2 flex justify-between items-center bg-gray-900">
        <div class="flex gap-2">
            <button onclick="setBrushColor('#000000')" class="w-8 h-8 rounded-full bg-black border border-white/20"></button>
            <button onclick="setBrushColor('#ef4444')" class="w-8 h-8 rounded-full bg-red-500"></button>
            <button onclick="setBrushColor('#3b82f6')" class="w-8 h-8 rounded-full bg-blue-500"></button>
            <button onclick="clearCanvas()" class="text-xs uppercase font-bold text-red-500 ml-2">Clear</button>
        </div>
        <button onclick="closeWhiteboard()" class="text-white font-bold px-4">Done</button>
    </div>
    <div id=" RANK-canvas-container">
        <canvas id="drawing-canvas"></canvas>
    </div>
</div>

<div id="story-overlay" style="display:none; position: fixed; inset: 0; background: black; z-index: 6000; align-items: center; justify-content: center; flex-direction: column;">
    <div id="story-prev" class="story-nav-btn absolute left-0 top-1/2 -translate-y-1/2 p-6 text-4xl opacity-50 hover:opacity-100 cursor-pointer z-[6010]" onclick="navStory(-1)">‚Äπ</div>
    <div id="story-media-container" class="relative w-full h-full flex items-center justify-center p-4"></div>
    <div id="story-next" class="story-nav-btn absolute right-0 top-1/2 Header- translate-y-1/2 p-6 text-4xl opacity-50 hover:opacity-100 cursor-pointer z-[6010]" onclick="navStory(1)">‚Ä∫</div>
    <button onclick="closeStory()" class="absolute top-6 right-6 text-white text-3xl z-[6020] opacity-70 hover:opacity-100">‚úï</button>
</div>

<div id="lightbox" onclick="this.style.display='none'" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; align-items: center; justify-content: center;">
    <img id="lightbox-img" class="max-w-[95%] max-h-[90%] rounded-lg shadow-2xl">
</div>

<div id="incoming-call-ui" class="hidden fixed inset-0 bg-black/95 z-[7000] flex flex-col items-center justify-center space-y-8">
    <div class="w-32 h-32 bg-slate-800 rounded-full flex items-center justify-center text-6xl animate-pulse mb-4">üîî</div>
    <div class="text-center">
        <h2 class="text-3xl font-bold mb-2">Incoming Call</h2>
        <p id="caller-id-disp" class="text-[var(--accent)] text-xl animate-pulse">...</p>
        <p id="call-type-disp" class="text-white/50 text-sm uppercase tracking-widest mt-2">Video Call</p>
    </div>
    <div class="flex gap-8 mt-8">
        <button onclick="answerCall()" class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center text-3xl shadow-2xl hover:scale-110 transition">üìû</button>
        <button onclick="rejectCall()" class="w-20 h-20 bg-red-500 rounded-full flex items-center justify-center text-3xl shadow-2xl hover:scale-110 transition">‚úï</button>
    </div>
</div>

<div id="outgoing-call-ui" class="hidden fixed inset-0 bg-black/95 z-[7000] flex flex-col items-center justify-center space-y-8">
    <div class="w-32 h-32 bg-slate-800 rounded-full flex items-center justify-center text-6xl opacity-50 mb-4 animate-bounce">üì°</div>
    <div class="text-center">
        <h2 class="text-3xl font-bold mb-2">Calling...</h2>
        <p class="text-white/50 text-sm uppercase tracking-widest mt-2">Waiting for answer</p>
    </div>
    <button onclick="cancelCall()" class="w-16 h-16 bg-red-500/20 text-red-500 border border-red-500 rounded-full flex items-center justify-center text-2xl mt-8 hover:bg-red-500 hover:text-white transition">‚úï</button>
</div>

<div id="video-grid" class="hidden fixed inset-0 bg-[#03050a] z-[3000]">
    <div class="absolute top-6 left-0 right-0 z-[3005] flex flex-col items-center pointer-events-none">
        <div id="call-status" class="text-[var(--accent)] text-xs font-bold tracking-widest uppercase animate-pulse mb-1">Connecting...</div>
        <div id="call-timer" class="text-white text-2xl font-mono font-bold drop-shadow-lg">00:00</div>
    </div>
    
    <div id="remote-video" class="w-full h-full flex items-center justify-center text-white/20 relative">
        <div class="absolute inset-0 flex items-center justify-center">Waiting for video...</div>
    </div>
    <div id="local-video" class="video-cover absolute top-20 right-6 w-32 h-48 border-2 border-white/20 rounded-2xl overflow-hidden z-[3001] bg-black shadow-2xl transition-all duration-300"></div>
    <div id="local-screen" class="hidden absolute top-72 right-6 w-48 h-32 border-2 border-blue-400/50 rounded-xl overflow-hidden z-[3001] bg-black shadow-2xl video-contain"></div>
    
    <div class="absolute bottom-10 left-0 right-0 flex justify-center items-center gap-4 z-[3002] px-4">
        <button id="btn-mute" onclick="toggleMute()" class="call-btn">üé§</button>
        <button id="btn-cam" onclick="toggleCam()" class="call-btn">üì∑</button>
        <button id="btn-draw" onclick="openWhiteboard()" class="call-btn bg-purple-500/20 text-purple-400">‚úèÔ∏è</button>
        <button id="btn-chat" onclick="toggleCallView()" class="call-btn bg-white/10">üí¨</button>
        <button onclick="hangUp()" class="call-btn !bg-red-600 hover:!bg-red-700">üìû</button>
    </div>
</div>

<div id="gallery-modal" class="modal-view"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold">Shared Gallery</h2><button onclick="document.getElementById('gallery-modal').style.display='none'" class="bg-white/10 px-4 py-1 rounded-full text-sm">Close</button></div><div id="gallery-content" class="grid grid-cols-3 gap-1 pb-20"></div></div>

<div id="logs-modal" class="modal-view"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-red-500">Deleted Logs</h2><button onclick="document.getElementById('logs-modal').style.display='none'" class="bg-white/10 px-4 py-1 rounded-full text-sm">Close</button></div><div id="logs-content" class="space-y-4 pb-20"></div></div>

<div id="story-log-modal" class="modal-view"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-pink-400">Story Archives</h2><button onclick="document.getElementById('story-log-modal').style.display='none'" class="bg-white/10 px-4 py-1 rounded-full text-sm">Close</button></div><div id="story-log-content" class="space-y-4 pb-20"></div></div>

<div id="return-to-call" onclick="toggleCallView()" style="display:none; position: absolute; top: 85px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; z-index: 9000; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); animation: pulseGreen 2s infinite;">üü¢ Return to Call</div>

<div id="chat-main">
    <header class="p-4 flex items-center justify-between glass-panel z-[50]">
        <div class="flex items-center gap-4">
            <button onclick="openSidebar()" class="text-2xl opacity-80 hover:opacity-100 transition">‚ò∞</button>
            <div onclick="handleStatusClick()" class="cursor-pointer">
                <div class="font-bold text-lg leading-none tracking-tight" id="partner-name">...</div>
                <div class="flex items-center gap-2">
                    <div id="partner-status" class="text-[11px] opacity-60 mt-0.5 font-medium">No status</div>
                    <div id="time-display" class="text-[10px] bg-white/10 px-2 rounded text-blue-300">--:--</div>
                </div>
                <div id="live-preview" class="text-[10px] text-[var(--accent)] italic h-3 transition-all"></div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="startCallRequest(false)" class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-sm hover:bg-white/10">üìû</button>
            <button onclick="startCallRequest(true)" class="w-8 h-8 rounded-full bg-[var(--accent)] flex items-center justify-center text-sm shadow-lg shadow-blue-500/20">üé•</button>
        </div>
    </header>
    
    <main id="messages"></main>
    
    <footer class="p-4 glass-panel">
        <div id="staging-area" class="grid grid-cols-4 gap-2 mb-2 empty: hidden"></div>
        
        <div id="reply-box" class="hidden bg-[var(--accent)]/10 p-3 rounded-t-2xl border-l-4 border-[var(--accent)] flex justify-between items-center mb-[-10px] pb-5">
            <span id="reply-text" class="text-[11px] text-[var(--accent)] italic truncate pr-2"></span>
            <button onclick="cancelReply()">&times;</button>
        </div>
        <div id="edit-box" class="hidden bg-yellow-500/10 p-3 rounded-t-2xl border-l-4 border-yellow-600 flex justify-between items-center mb-[-10px] pb-5">
            <span class="text-[11px] text-yellow-300 italic">Editing message...</span>
            <button onclick="cancelEdit()">&times;</button>
        </div>
        
        <form id="chat-form" class="flex items-center input-pill rounded-full p-1 pl-2 shadow-xl">
            <label class="cursor-pointer opacity-50 p-2 hover:opacity-100 transition">üìé <input type="file" id="file-input" class="hidden" accept="image/*" multiple onchange="handleFileSelect(this)"></label>
            <button type="button" id="mic-btn" onclick="toggleRecording()" class="opacity-50 p-2 hover:opacity-100 transition text-lg">üéôÔ∏è</button>
            <input id="msg-input" placeholder="Type a message..." autocomplete="off" class="flex-1 bg-transparent py-3 px-2 text-sm outline-none placeholder:text-white/30">
            <button type="submit" id="send-btn" class="bg-[var(--accent)] text-white font-bold px-6 py-3 rounded-full text-[11px] uppercase tracking-wide shadow-lg hover:brightness-110 transition">Send</button>
        </form>
    </footer>
</div>

<div id="sidebar" class="fixed left-[-300px] top-0 bottom-0 w-[280px] z-[1000] p-6 flex flex-col transition-all duration-300 backdrop-blur-md overflow-y-auto">
    <div class="bg-gradient-to-br from-pink-500/20 to-purple-500/20 border border-white/5 rounded-3xl p-6 mb-6 text-center shadow-lg">
        <p class="text-[10px] font-bold text-pink-400 uppercase tracking-widest mb-1">Days Together</p>
        <h1 id="days-counter" class="text-4xl font-black text-pink-300 drop-shadow-md">0</h1>
    </div>

    <div class="bg-gradient-to-br from-blue-500/20 to-cyan-500/20 border border-white/5 rounded-3xl p-4 mb-6 text-center shadow-lg">
        <p class="text-[9px] font-bold text-cyan-300 uppercase tracking-widest mb-1">Daily Question</p>
        <p id="daily-prompt" class="text-sm italic opacity-90">...</p>
    </div>

    <h2 id="me-name" class="text-center text-xl font-bold mb-6 opacity-90">...</h2>
    
    <div class="flex-1 space-y-4">
        <div class="bg-white/5 p-4 rounded-2xl space-y-3 border border-white/5">
             <p class="text-[10px] font-bold opacity-40 uppercase tracking-widest">Settings</p>
             <div class="flex items-center justify-between">
                 <span class="text-xs">Sleep Mode</span>
                 <label class="switch"><input type="checkbox" id="sleep-toggle" onchange="toggleSleepMode()"><span class="slider"></span></label>
             </div>
             <div class="flex items-center justify-between">
                 <span class="text-xs">Pin Lock</span>
                 <label class="switch"><input type="checkbox" id="pin-toggle" onchange="togglePinSetting()"><span class="slider"></span></label>
             </div>
        </div>

        <div class="bg-white/5 p-4 rounded-2xl space-y-3 border border-white/5">
            <p class="text-[10px] font-bold opacity-40 uppercase tracking-widest">My Status</p>
            <input id="status-txt-input" placeholder="What's up?" class="w-full bg-black/40 p-3 rounded-xl text-xs outline-none border border-white/5 focus:border-[var(--accent)] transition">
            <div class="flex flex-col gap-2">
                <label class="bg-white/5 p-2 rounded-lg text-[10px] text-center cursor-pointer border border-dashed border-white/20 hover:border-white/40 transition">üì∏ Add Story Media<input type="file" id="status-media-input" class="hidden" accept="image/*,video/*" multiple></label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="updateStatusFromSidebar()" id="update-status-btn" class="bg-[var(--accent)] p-2 rounded-lg text-[10px] font-bold uppercase hover:brightness-110">Update</button>
                    <button onclick="removeStatus()" class="bg-red-500/20 text-red-400 p-2 rounded-lg text-[10px] font-bold uppercase hover:bg-red-500/30">Reset</button>
                </div>
            </div>
        </div>

        <div class="bg-white/5 p-4 rounded-2xl space-y-3 border border-white/5">
            <p class="text-[10px] font-bold opacity-40 uppercase tracking-widest">Mutual Theme</p>
            <div class="grid grid-cols-4 gap-2 px-2 items-center">
                <div onclick="setTheme('midnight')" class="theme-dot bg-blue-900" title="Midnight"></div>
                <div onclick="setTheme('love')" class="theme-dot bg-red-900" title="Love"></div>
                <div onclick="setTheme('forest')" class="theme-dot bg-green-900" title="Forest"></div>
                <div onclick="setTheme('lavender')" class="theme-dot bg-purple-900" title="Lavender"></div>
                <div onclick="setTheme('sunset')" class="theme-dot bg-orange-700" title="Sunset"></div>
                <div onclick="setTheme('ocean')" class="theme-dot bg-cyan-900" title="Ocean"></div>
                <div onclick="setTheme('retro')" class="theme-dot bg-amber-900" title="Retro"></div>
                <label class="theme-dot theme-dot-custom cursor-pointer" title="Custom Image">
                    IMG <input type="file" id="theme-file-input" class="hidden" accept="image/*" onchange="uploadCustomTheme(this)">
                </label>
            </div>
        </div>

        <button onclick="toggleGallery(true)" class="w-full text-left p-4 bg-white/5 rounded-2xl hover:bg-white/10 transition text-sm font-semibold">üñºÔ∏è Shared Gallery</button>
        
        <div id="rj-suite" class="hidden pt-6 mt-6 border-t border-white/10 space-y-3">
             <p class="text-[10px] font-bold text-[var(--accent)] uppercase tracking-widest px-2">RJ Tools</p>
             <div class="grid grid-cols-2 gap-2">
                <button onclick="sendInteraction('lovetap')" class="p-3 bg-pink-500/20 text-pink-400 rounded-xl font-bold text-center text-xs">‚ù§Ô∏è Spam</button>
                <button onclick="sendInteraction('vibrate')" class="p-3 bg-blue-500/20 text-blue-400 rounded-xl font-bold text-center text-xs">üì≥ Buzz</button>
             </div>
             
             <div class="p-3 bg-red-500/10 rounded-xl border border-red-500/20 space-y-2">
                <p class="text-[9px] font-bold text-red-400 uppercase tracking-widest">üõ°Ô∏è Manage Allyvia's Security</p>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="adminDisablePin()" class="p-2 bg-red-500/20 text-red-300 rounded-lg text-[10px] font-bold">Disable Pin</button>
                    <button onclick="adminChangePin()" class="p-2 bg-blue-500/20 text-blue-300 rounded-lg text-[10px] font-bold">Change Pin</button>
                </div>
             </div>

            <button onclick="viewDeletedLogs()" class="w-full text-left p-4 bg-red-500/10 text-red-400 rounded-2xl font-bold text-sm border border-red-500/20">üóëÔ∏è View Deleted Logs</button>
            <button onclick="viewStoryLogs()" class="w-full text-left p-4 bg-pink-500/10 text-pink-400 rounded-2xl font-bold text-sm border border-pink-500/20">üìú Story Archives</button>
        </div>
    </div>
</div>

<div id="overlay-bg" onclick="closeSidebar()" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[900]"></div>

<script>
    // Haptic feedback helper (mobile only)
    function haptic(type = 'light') {
        if ('vibrate' in navigator) {
            const patterns = {
                light: [30],
                medium: [50],
                heavy: [100, 50, 100],
                heartbeat: [100, 50, 100, 50, 200]
            };
            navigator.vibrate(patterns[type] || patterns.light);
        }
    }

    const SB_URL = 'https://jwfgaulakwiwextmqbov.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3ZmdhdWxha3dpd2V4dG1xYm92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NzU1MTYsImV4cCI6MjA4MjI1MTUxNn0.DBOoI_wLNGyB1LLfXzyAbVvEkVMj9XcCJie-HAZ0_d4';
    const _db = supabase.createClient(SB_URL, SB_KEY);
    
    // STATE
    let me, you, chatChannel, stagedFiles = [], replyId = null, editingId = null;
    let partnerStatusData = null, allMessagesCache = [];
    let storyItems = [], storyIndex = 0;
    let loadTimeout = null;
    let mediaRecorder = null, audioChunks = [];
    let isSleepMode = false;
    // PIN STATES
    let pinCode = null, enteredPin = "", pinMode = "unlock";
    // DRAWING
    let canvas, ctx, isDrawing = false, lastX = 0, lastY = 0;
    let drawingThrottle = null;

    const notifSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
    notifSound.volume = 0.05;
    const AGORA_APP_ID = "4f6c6c2002784152a8366dec12f1b4c0";
    let rtc = { client: null, localVideoTrack: null, localAudioTrack: null, screenTrack: null, isMuted: false, isCamOff: false };
    let incomingCallData = null, callTimerInterval = null, callSeconds = 0, wakeLock = null;

    async function init() {
        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            try {
                const reg = await navigator.serviceWorker.register('sw.js');
                console.log('SW registered', reg);
            } catch (err) {
                console.log('SW registration failed', err);
            }
        }

        const code = localStorage.getItem('chat_secret_code') || prompt("Access Code:");
        const { data } = await _db.from('chat_codes').select('*').eq('code', code).single();
        if(!data) return;
        
        me = data.username;
        you = (me === 'RJ' ? 'Allyvia' : 'RJ');
        
        if(data.pin_code) {
            pinCode = data.pin_code;
            showPinScreen("unlock");
            document.getElementById('pin-toggle').checked = true;
        } else {
            document.getElementById('pin-toggle').checked = false;
        }

        localStorage.setItem('chat_secret_code', code);
        document.getElementById('me-name').textContent = me;
        if(me === 'RJ') document.getElementById('rj-suite').classList.remove('hidden');

        const savedBg = localStorage.getItem('custom_bg');
        if(savedBg) {
             document.body.style.backgroundImage = `url('${savedBg}')`;
             applyTheme('custom');
        } else if(data.current_theme) {
             applyTheme(data.current_theme);
        }

        const prompts = ["Who would secretly make a great spy?", "Which one of us would get lost first on a hike?", "Genre you‚Äôd binge together first", "If you could have sex with any celebrity, who would it be‚Äîand what do you think it would it be like?", "What's your definition of amazing sex?", "Favorite memory together?", "Dream vacation spot?", "One thing you love about me?", "Song that reminds you of us?", "Ideal date night?", "First and current impression of me? and deffrence", "Hottest thing I've done and said?", "First and current impression of me? and deffrence", "whats your dreams and goals?"];
        const dayIndex = new Date().getDay(); 
        document.getElementById('daily-prompt').textContent = prompts[dayIndex];

        chatChannel = _db.channel('chat-ultra');
        chatChannel
            .on('broadcast', { event: 'admin' }, p => handleInteraction(p.payload))
            .on('broadcast', { event: 'refresh' }, () => { loadMessages(); loadStatuses(); })
            .on('broadcast', { event: 'theme_change' }, p => applyTheme(p.payload.theme))
            .on('broadcast', { event: 'draw_event' }, p => drawOnCanvas(p.payload, false))
            .on('broadcast', { event: 'typing' }, p => {
                const el = document.getElementById('live-preview');
                el.textContent = p.payload.text ? (me === 'RJ' ? `Typing: ${p.payload.text}` : `${you} is typing...`) : "";
                el.style.opacity = p.payload.text ? 1 : 0;
                if(p.payload.localTime) document.getElementById('time-display').textContent = p.payload.localTime;
            })
            .on('broadcast', { event: 'call-signal' }, p => handleCallSignal(p.payload))
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'private_messages' }, (p) => {
                if(p.new.receiver === me) { handleIncomingMessage(p.new); markAsRead(p.new.id); }
                loadMessages();
            })
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'private_messages' }, () => loadMessages())
            .subscribe();
            
        loadMessages(); loadStatuses();
        updateDaysCounter();
        
        if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
            document.body.addEventListener('click', () => Notification.requestPermission(), { once: true });
        }

        setInterval(() => {
             chatChannel.send({ type: 'broadcast', event: 'typing', payload: { text: document.getElementById('msg-input').value, localTime: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) } });
        }, 30000);

        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'visible') {
                loadMessages();
                loadStatuses();
                chatChannel.subscribe();
            }
        });

        // Auto-focus input after unlock
        document.getElementById('msg-input')?.focus();
    }

    // Add haptics to interactions
    function sendInteraction(type) {
        haptic(type === 'lovetap' ? 'heartbeat' : 'medium');
        chatChannel.send({ type: 'broadcast', event: 'admin', payload: { type } });
    }

    // Haptic on send (in form submit)
    document.getElementById('chat-form').onsubmit = e => {
        e.preventDefault();
        haptic('light');
        const v = document.getElementById('msg-input').value;
        if(v.trim() || stagedFiles.length) sendMsg(v);
    };

    // ALL YOUR ORIGINAL FUNCTIONS BELOW (unchanged - pin, whiteboard, calls, messaging, themes, etc.)
    // ... [all the rest of your original script exactly as you had it] ...

    init();
</script>
</body>
</html>
