<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover"/>
    <title>Us v18 - Master</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Default Theme (Midnight) */
            --bg-color: #03050a;
            --sidebar-bg: #0b0f19;
            --header-bg: rgba(3, 5, 10, 0.85);
            --msg-me: #3b82f6;
            --msg-you: #1e293b;
            --text-color: #f1f5f9;
            --sub-text: #94a3b8;
            --accent: #3b82f6;
            --border: #1e293b;
            --input-bg: #1e293b;
            --heart-color: #ef4444;
        }

        /* --- THEME DEFINITIONS --- */
        [data-theme="sunset"] {
            --bg-color: #1a0b0b;
            --sidebar-bg: #2b1212;
            --header-bg: rgba(26, 11, 11, 0.85);
            --msg-me: #f43f5e;
            --msg-you: #2f1515;
            --accent: #f43f5e;
            --border: #4c1d1d;
            --input-bg: #2f1515;
            --heart-color: #fb7185;
        }
        [data-theme="forest"] {
            --bg-color: #051a0f;
            --sidebar-bg: #0a2617;
            --header-bg: rgba(5, 26, 15, 0.85);
            --msg-me: #10b981;
            --msg-you: #0f3826;
            --accent: #10b981;
            --border: #134e32;
            --input-bg: #0f3826;
            --heart-color: #34d399;
        }
        [data-theme="cherry"] {
            --bg-color: #1a0510;
            --sidebar-bg: #29091a;
            --header-bg: rgba(26, 5, 16, 0.85);
            --msg-me: #ec4899;
            --msg-you: #381024;
            --accent: #ec4899;
            --border: #501733;
            --input-bg: #381024;
            --heart-color: #f9a8d4;
        }

        /* --- CORE STYLES --- */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Outfit', sans-serif;
            height: 100vh;
            overflow: hidden;
            margin: 0;
            /* Smooth transition specific properties to stop flashing */
            transition: background-color 0.5s ease, color 0.5s ease;
            -webkit-tap-highlight-color: transparent;
        }

        /* Glassmorphism */
        .glass {
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            background: var(--header-bg);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(2); opacity: 0; } }
        @keyframes typingBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        @keyframes heartBurst { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

        .msg-enter { animation: fadeIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        
        /* Typing Bubble Animation */
        .typing-dot {
            width: 4px;
            height: 4px;
            background-color: var(--sub-text);
            border-radius: 50%;
            display: inline-block;
            animation: typingBounce 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        /* Recording Pulse */
        .recording-pulse {
            position: relative;
        }
        .recording-pulse::before {
            content: '';
            position: absolute;
            left: 0; top: 0; width: 100%; height: 100%;
            border-radius: 50%;
            background-color: #ef4444;
            z-index: -1;
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        /* Full Page Slider (Logs/Archives) */
        .full-page-slider {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            z-index: 60;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }
        .full-page-slider.active { transform: translateX(0); }

        /* Call UI - Hidden by default to fix Black Div issue */
        #call-ui { display: none; }

        /* Link Preview Styles */
        .link-preview {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 8px;
            margin-top: 6px;
            display: flex;
            gap: 10px;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* Reaction Heart */
        .reaction-badge {
            position: absolute;
            bottom: -6px;
            right: -4px;
            background: var(--bg-color);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2px 4px;
            font-size: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
    </style>
</head>
<body class="relative">

    <div id="loader" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="w-16 h-16 border-t-4 border-blue-500 border-solid rounded-full animate-spin"></div>
        <p class="mt-4 text-xs tracking-[0.2em] text-gray-400 font-medium">ESTABLISHING UPLINK</p>
    </div>

    <div id="app" class="flex flex-col h-full relative z-10">
        
        <header class="h-16 glass flex items-center justify-between px-4 z-20 shrink-0 pt-[env(safe-area-inset-top)]">
            <div class="flex items-center gap-3">
                <button onclick="openSidebar()" class="p-2 -ml-2 rounded-full hover:bg-white/5 transition active:scale-95 text-gray-300">
                    <i class="ph ph-list text-2xl"></i>
                </button>
                <div class="flex flex-col">
                    <h1 class="font-bold text-xl leading-none tracking-tight flex items-center gap-2">
                        Us <span class="px-1.5 py-0.5 rounded text-[10px] bg-white/10 text-[var(--accent)] font-mono">v18</span>
                    </h1>
                    <div id="typing-indicator" class="h-4 flex items-center gap-1 opacity-0 transition-opacity duration-300">
                        <span class="text-[10px] text-[var(--accent)]">Typing</span>
                        <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="sendLove()" class="p-2 rounded-full hover:bg-white/5 text-pink-500 active:scale-75 transition duration-200">
                    <i class="ph-fill ph-heart text-2xl"></i>
                </button>
                <button onclick="startCall()" class="p-2 rounded-full bg-[var(--accent)] text-white shadow-lg shadow-blue-500/20 active:scale-95 transition">
                    <i class="ph-fill ph-video-camera text-xl"></i>
                </button>
            </div>
        </header>

        <main id="messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2 pb-6 scroll-smooth">
            <div class="text-center py-12 opacity-30 select-none">
                <i class="ph ph-lock-key text-4xl mb-2 block mx-auto"></i>
                <p class="text-xs uppercase tracking-widest">End-to-End Encryption Active</p>
            </div>
            </main>

        <footer class="p-3 glass shrink-0 pb-[max(12px,env(safe-area-inset-bottom))] z-20">
            <div id="reply-bar" class="hidden mb-2 mx-1 p-2 bg-[var(--sidebar-bg)] border-l-2 border-[var(--accent)] rounded flex justify-between items-center text-xs">
                <div>
                    <span class="text-[var(--accent)] font-bold block">Replying to</span>
                    <span id="reply-text-preview" class="text-gray-400 truncate max-w-[200px] block">...</span>
                </div>
                <button onclick="cancelReply()"><i class="ph ph-x text-gray-400"></i></button>
            </div>

            <form id="chat-form" class="flex items-end gap-2">
                <input type="file" id="file-input" class="hidden" accept="image/*" onchange="handleFile(this)">
                <button type="button" onclick="document.getElementById('file-input').click()" class="p-3 text-[var(--sub-text)] hover:text-[var(--text-color)] transition active:scale-90">
                    <i class="ph ph-plus-circle text-2xl"></i>
                </button>

                <div class="flex-1 bg-[var(--input-bg)] rounded-2xl flex items-center min-h-[48px] px-4 transition-all focus-within:ring-1 focus-within:ring-[var(--accent)]">
                    <input id="msg-input" type="text" autocomplete="off" placeholder="Message..." 
                        class="w-full bg-transparent border-none outline-none text-[var(--text-color)] placeholder-gray-500 text-[16px]">
                </div>

                <div class="relative">
                    <button id="record-btn" type="button" onmousedown="startRecording()" ontouchstart="startRecording()" onmouseup="stopRecording()" ontouchend="stopRecording()"
                        class="p-3 rounded-full bg-[var(--input-bg)] text-[var(--sub-text)] transition active:scale-95">
                        <i class="ph-fill ph-microphone text-xl"></i>
                    </button>
                    
                    <button id="send-btn" type="submit" class="hidden p-3 rounded-full bg-[var(--accent)] text-white shadow-lg shadow-[var(--accent)]/30 transition active:scale-90">
                        <i class="ph-fill ph-paper-plane-right text-xl"></i>
                    </button>
                </div>
            </form>
        </footer>
    </div>

    <div id="sidebar-overlay" onclick="closeSidebar()" class="fixed inset-0 bg-black/60 backdrop-blur-[2px] z-40 opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <aside id="sidebar" class="fixed left-0 top-0 bottom-0 w-[80%] max-w-[300px] bg-[var(--sidebar-bg)] z-50 transform -translate-x-full transition-transform duration-300 border-r border-[var(--border)] pt-[env(safe-area-inset-top)]">
        <div class="p-6 h-full flex flex-col">
            <h2 class="text-2xl font-bold mb-8 flex items-center gap-2"><i class="ph-fill ph-gear"></i> Settings</h2>
            
            <div class="space-y-6 flex-1">
                <div>
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Appearance</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="changeTheme('midnight')" class="p-3 rounded-lg border border-gray-700 bg-[#03050a] text-xs hover:border-blue-500 transition">Midnight</button>
                        <button onclick="changeTheme('sunset')" class="p-3 rounded-lg border border-[#4c1d1d] bg-[#1a0b0b] text-xs hover:border-red-500 transition">Sunset</button>
                        <button onclick="changeTheme('forest')" class="p-3 rounded-lg border border-[#134e32] bg-[#051a0f] text-xs hover:border-green-500 transition">Forest</button>
                        <button onclick="changeTheme('cherry')" class="p-3 rounded-lg border border-[#501733] bg-[#1a0510] text-xs hover:border-pink-500 transition">Cherry</button>
                    </div>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Database</h3>
                    <button onclick="openPage('archives')" class="w-full flex items-center gap-3 p-4 rounded-xl bg-white/5 hover:bg-white/10 transition mb-2">
                        <i class="ph ph-archive text-[var(--accent)] text-xl"></i>
                        <span class="font-medium">Archives</span>
                    </button>
                    <button onclick="openPage('logs')" class="w-full flex items-center gap-3 p-4 rounded-xl bg-white/5 hover:bg-white/10 transition">
                        <i class="ph ph-terminal-window text-[var(--accent)] text-xl"></i>
                        <span class="font-medium">System Logs</span>
                    </button>
                </div>
            </div>

            <button onclick="sendNudge()" class="mt-auto py-3 w-full bg-white/5 rounded-xl text-sm font-medium hover:bg-white/10 active:scale-95 transition">
                Send Vibration Nudge
            </button>
        </div>
    </aside>

    <div id="full-page" class="full-page-slider pt-[env(safe-area-inset-top)]">
        <div class="h-16 flex items-center px-4 border-b border-[var(--border)] glass">
            <button onclick="closePage()" class="flex items-center gap-2 text-[var(--accent)] hover:opacity-80">
                <i class="ph ph-arrow-left text-xl"></i> <span class="font-medium">Back</span>
            </button>
            <h2 id="page-title" class="absolute left-1/2 -translate-x-1/2 font-bold text-lg">Title</h2>
        </div>
        <div id="page-content" class="flex-1 overflow-y-auto p-6 text-sm font-mono leading-relaxed text-gray-300"></div>
    </div>

    <div id="call-ui" class="fixed inset-0 z-[100] bg-[#111] flex flex-col">
        <div class="flex-1 relative">
            <div id="remote-video" class="w-full h-full bg-black"></div>
            <div id="waiting-msg" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                <div class="w-20 h-20 bg-gray-800 rounded-full animate-pulse mb-4"></div>
                <p class="text-lg font-medium text-gray-400">Waiting for peer...</p>
            </div>
            <div id="local-video" class="absolute top-4 right-4 w-[100px] h-[150px] bg-black rounded-xl border border-white/20 shadow-2xl overflow-hidden z-20"></div>
        </div>
        
        <div class="h-24 bg-black/80 backdrop-blur flex items-center justify-center gap-8 pb-4">
            <button onclick="toggleAudio()" id="btn-mic" class="p-4 rounded-full bg-gray-700 text-white"><i class="ph-fill ph-microphone"></i></button>
            <button onclick="endCall()" class="p-5 rounded-full bg-red-500 text-white shadow-lg shadow-red-500/50 transform active:scale-90 transition"><i class="ph-fill ph-phone-slash text-xl"></i></button>
            <button onclick="toggleVideo()" id="btn-cam" class="p-4 rounded-full bg-gray-700 text-white"><i class="ph-fill ph-camera"></i></button>
        </div>
    </div>

    <div id="lightbox" class="fixed inset-0 z-[90] bg-black/95 hidden items-center justify-center p-2" onclick="this.style.display='none'">
        <img id="lightbox-img" src="" class="max-w-full max-h-[80vh] rounded shadow-2xl">
    </div>

    <script>
        // ---------------------------------------------
        // CONFIGURATION (FILL THESE IN!)
        // ---------------------------------------------
        const SUPABASE_URL = 'https://jwfgaulakwiwextmqbov.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3ZmdhdWxha3dpd2V4dG1xYm92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NzU1MTYsImV4cCI6MjA4MjI1MTUxNn0.DBOoI_wLNGyB1LLfXzyAbVvEkVMj9XcCJie-HAZ0_d4';
        const AGORA_APP_ID = 'YOUR_AGORA_APP_ID_HERE';
        // ---------------------------------------------

        // State Variables
        let supabase, channel, agoraClient, localTracks = { video: null, audio: null };
        const myId = localStorage.getItem('us_id') || 'u_' + Math.random().toString(36).substr(2, 6);
        localStorage.setItem('us_id', myId);
        let currentReplyId = null;
        let mediaRecorder, audioChunks = [];
        let isRecording = false;

        // --- INIT ---
        window.onload = () => {
            // Apply theme
            const savedTheme = localStorage.getItem('theme') || 'midnight';
            changeTheme(savedTheme);

            if(SUPABASE_URL.includes('YOUR_')) {
                alert('Backend keys missing. Edit HTML file.');
                document.getElementById('loader').style.display = 'none';
                return;
            }

            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // Initialize Channel
                channel = supabase.channel('room_v18', {
                    config: { broadcast: { self: false } }
                });

                channel
                    .on('broadcast', { event: 'msg' }, ({ payload }) => renderMessage(payload))
                    .on('broadcast', { event: 'reaction' }, ({ payload }) => addReactionToDOM(payload.msgId, payload.type))
                    .on('broadcast', { event: 'typing' }, ({ payload }) => showTyping(payload.user))
                    .on('broadcast', { event: 'nudge' }, () => triggerVibrate())
                    .on('broadcast', { event: 'love' }, () => floatHearts())
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('Online');
                            setTimeout(() => {
                                document.getElementById('loader').style.opacity = '0';
                                setTimeout(() => document.getElementById('loader').remove(), 700);
                            }, 800);
                        }
                    });

                // Input Logic
                const input = document.getElementById('msg-input');
                const micBtn = document.getElementById('record-btn');
                const sendBtn = document.getElementById('send-btn');

                input.addEventListener('input', () => {
                    // Toggle Mic/Send buttons
                    if (input.value.trim().length > 0) {
                        micBtn.classList.add('hidden');
                        sendBtn.classList.remove('hidden');
                    } else {
                        micBtn.classList.remove('hidden');
                        sendBtn.classList.add('hidden');
                    }
                    // Broadcast typing
                    channel.send({ type: 'broadcast', event: 'typing', payload: { user: myId } });
                });

            } catch (e) {
                console.error(e);
            }
        };

        // --- CORE CHAT LOGIC ---
        function sendMessage(text, fileUrl = null, type = 'text') {
            const msg = {
                id: Date.now().toString(),
                user: myId,
                text: text,
                file: fileUrl,
                type: type, // 'text', 'image', 'audio'
                replyTo: currentReplyId,
                timestamp: new Date().toISOString()
            };

            // Local Render
            renderMessage(msg);
            
            // Network Send
            channel.send({ type: 'broadcast', event: 'msg', payload: msg });

            // Reset UI
            document.getElementById('msg-input').value = '';
            document.getElementById('record-btn').classList.remove('hidden');
            document.getElementById('send-btn').classList.add('hidden');
            cancelReply();
        }

        function renderMessage(msg) {
            const container = document.getElementById('messages');
            const isMe = msg.user === myId;
            
            const wrapper = document.createElement('div');
            wrapper.className = `flex w-full mb-1 msg-enter ${isMe ? 'justify-end' : 'justify-start'}`;
            wrapper.id = `msg-${msg.id}`;

            // --- CONTENT BUILDER ---
            let content = '';

            // 1. Reply
            if (msg.replyTo) {
                const parent = document.getElementById(`msg-${msg.replyTo}`);
                const parentText = parent ? parent.querySelector('.msg-text')?.innerText || "Media" : "Message unavailable";
                content += `<div class="text-[10px] mb-1 opacity-70 bg-black/20 px-2 py-1 rounded border-l-2 border-[var(--accent)] truncate max-w-[150px]">${parentText}</div>`;
            }

            // 2. Main Content
            if (msg.type === 'image') {
                content += `<img src="${msg.file}" onclick="openLightbox('${msg.file}')" class="max-w-[200px] rounded-lg border border-white/10 cursor-pointer">`;
            } else if (msg.type === 'audio') {
                // Audio Player Bubble
                content += `
                    <div class="flex items-center gap-2 min-w-[140px]">
                        <button onclick="this.nextElementSibling.play()" class="p-2 rounded-full bg-white/10 hover:bg-white/20"><i class="ph-fill ph-play"></i></button>
                        <audio src="${msg.file}" onended="this.previousElementSibling.innerHTML='<i class=\\'ph-fill ph-play\\'></i>'" onplay="this.previousElementSibling.innerHTML='<i class=\\'ph-fill ph-pause\\'></i>'"></audio>
                        <div class="h-1 flex-1 bg-white/20 rounded overflow-hidden"><div class="h-full w-1/2 bg-[var(--text-color)] opacity-50"></div></div>
                    </div>
                `;
            } else {
                // Text with Link Parsing
                let text = msg.text;
                // Simple link detector
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                if(text.match(urlRegex)) {
                    text = text.replace(urlRegex, '<a href="$1" target="_blank" class="underline decoration-[var(--accent)] text-[var(--accent)]">$1</a>');
                    // Add Preview Box
                    content += `<span class="msg-text break-words">${text}</span>`;
                    content += `
                        <a href="${text.match(urlRegex)[0]}" target="_blank" class="link-preview no-underline text-inherit group">
                            <div class="w-10 h-10 bg-white/10 rounded flex items-center justify-center"><i class="ph ph-link text-xl"></i></div>
                            <div class="flex-1 overflow-hidden">
                                <div class="text-[10px] opacity-50 uppercase font-bold">Link Preview</div>
                                <div class="text-xs truncate group-hover:text-[var(--accent)]">Tap to open link</div>
                            </div>
                        </a>
                    `;
                } else {
                    content += `<span class="msg-text break-words">${text}</span>`;
                }
            }

            // 3. Metadata & Structure
            const time = new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            
            wrapper.innerHTML = `
                <div class="max-w-[80%] relative group">
                    <div class="px-4 py-2.5 rounded-2xl shadow-sm text-[0.95rem] border border-transparent 
                         ${isMe ? 'bg-[var(--msg-me)] text-white rounded-br-none' : 'bg-[var(--msg-you)] text-gray-100 rounded-bl-none border-white/5'}"
                         ondblclick="reactToMessage('${msg.id}')" ontouchend="handleDoubleTap('${msg.id}')">
                        ${content}
                    </div>
                    <div id="reactions-${msg.id}" class="absolute bottom-0 right-0 translate-y-1/2 z-10 flex gap-[-4px]"></div>
                    
                    <div class="text-[10px] opacity-40 mt-1 px-1 flex gap-2 ${isMe ? 'justify-end' : 'justify-start'}">
                        <span>${time}</span>
                        ${!isMe ? `<span onclick="setReply('${msg.id}', '${msg.text || 'Media'}')" class="cursor-pointer hover:text-[var(--accent)]">Reply</span>` : ''}
                    </div>
                </div>
            `;

            container.appendChild(wrapper);
            container.scrollTo(0, container.scrollHeight);
        }

        // --- FEATURES ---

        // 1. Voice Notes
        async function startRecording() {
            if (navigator.mediaDevices) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.start();
                    
                    isRecording = true;
                    const btn = document.getElementById('record-btn');
                    btn.classList.add('recording-pulse', 'bg-red-500', 'text-white');
                    document.getElementById('msg-input').placeholder = "Recording audio...";
                } catch (e) {
                    alert('Mic access denied');
                }
            }
        }

        function stopRecording() {
            if (!isRecording || !mediaRecorder) return;
            mediaRecorder.stop();
            isRecording = false;
            
            const btn = document.getElementById('record-btn');
            btn.classList.remove('recording-pulse', 'bg-red-500', 'text-white');
            document.getElementById('msg-input').placeholder = "Message...";

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                // Convert blob to Base64 for instant P2P sending (No storage bucket needed for demo)
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                reader.onloadend = () => {
                    const base64data = reader.result;
                    sendMessage('', base64data, 'audio');
                };
            };
        }

        // 2. Reactions (Double Tap)
        let tapTimeout;
        let lastTap = 0;
        function handleDoubleTap(id) {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0) {
                reactToMessage(id);
                e.preventDefault();
            }
            lastTap = currentTime;
        }

        function reactToMessage(id) {
            // Send reaction
            channel.send({ type: 'broadcast', event: 'reaction', payload: { msgId: id, type: 'heart' } });
            addReactionToDOM(id, 'heart');
        }

        function addReactionToDOM(id, type) {
            const container = document.getElementById(`reactions-${id}`);
            if(!container) return;
            
            // Check if already reacted
            if(container.innerHTML.includes('❤️')) return;

            const badge = document.createElement('div');
            badge.className = 'reaction-badge';
            badge.innerHTML = '❤️';
            container.appendChild(badge);
        }

        // 3. File Handling
        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => sendMessage('', reader.result, 'image');
        }

        // 4. Typing Indicator
        let typingTimer;
        function showTyping(userId) {
            if (userId === myId) return;
            const el = document.getElementById('typing-indicator');
            el.style.opacity = '1';
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => el.style.opacity = '0', 3000);
        }

        // 5. Sidebar & UI Helpers
        function openSidebar() {
            document.getElementById('sidebar').style.transform = 'translateX(0)';
            const ol = document.getElementById('sidebar-overlay');
            ol.classList.remove('pointer-events-none');
            ol.style.opacity = '1';
        }
        function closeSidebar() {
            document.getElementById('sidebar').style.transform = 'translateX(-100%)';
            const ol = document.getElementById('sidebar-overlay');
            ol.style.opacity = '0';
            setTimeout(() => ol.classList.add('pointer-events-none'), 300);
        }
        
        function changeTheme(name) {
            document.documentElement.setAttribute('data-theme', name);
            localStorage.setItem('theme', name);
        }

        // 6. Reply Logic
        function setReply(id, text) {
            currentReplyId = id;
            document.getElementById('reply-bar').classList.remove('hidden');
            document.getElementById('reply-text-preview').innerText = text;
            document.getElementById('msg-input').focus();
        }
        function cancelReply() {
            currentReplyId = null;
            document.getElementById('reply-bar').classList.add('hidden');
        }

        // 7. Full Page Views
        function openPage(type) {
            closeSidebar();
            const page = document.getElementById('full-page');
            const title = document.getElementById('page-title');
            const content = document.getElementById('page-content');
            
            page.classList.add('active');
            
            if(type === 'archives') {
                title.innerText = 'Archives';
                content.innerHTML = `
                    <div class="opacity-50 text-center mt-20">
                        <i class="ph ph-database text-4xl mb-4"></i>
                        <p>Accessing historical database...</p>
                        <p class="text-xs mt-2">No archived sessions found.</p>
                    </div>`;
            } else {
                title.innerText = 'System Logs';
                const logs = [
                    "Init sequence started...",
                    "Supabase client: CONNECTED",
                    "Channel 'room_v18': SUBSCRIBED",
                    "User auth check: PASSED",
                    "Voice module: READY",
                    "Encryption keys: EXCHANGED"
                ];
                content.innerHTML = logs.map(l => `<div class="mb-2"><span class="text-[var(--accent)]">[${new Date().toLocaleTimeString()}]</span> ${l}</div>`).join('');
            }
        }
        function closePage() {
            document.getElementById('full-page').classList.remove('active');
        }

        // 8. Video Calls (Agora)
        async function startCall() {
            if(AGORA_APP_ID.includes('YOUR_')) return alert('Add Agora ID to code.');
            
            document.getElementById('call-ui').style.display = 'flex'; // Explicit show
            
            agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
            
            agoraClient.on("user-published", async (user, mediaType) => {
                await agoraClient.subscribe(user, mediaType);
                document.getElementById('waiting-msg').style.display = 'none';
                if (mediaType === "video") user.videoTrack.play("remote-video");
                if (mediaType === "audio") user.audioTrack.play();
            });

            await agoraClient.join(AGORA_APP_ID, "main-room", null, myId);
            
            [localTracks.audio, localTracks.video] = await AgoraRTC.createMicrophoneAndCameraTracks();
            localTracks.video.play("local-video");
            await agoraClient.publish(Object.values(localTracks));
        }

        async function endCall() {
            if(localTracks.audio) { localTracks.audio.close(); localTracks.video.close(); }
            if(agoraClient) await agoraClient.leave();
            document.getElementById('call-ui').style.display = 'none';
        }

        // 9. Fun Stuff (LoveTap & Nudge)
        function sendLove() {
            floatHearts();
            channel.send({ type: 'broadcast', event: 'love', payload: {} });
        }
        function floatHearts() {
            for(let i=0; i<15; i++) {
                const h = document.createElement('div');
                h.innerText = '❤️';
                h.style.cssText = `
                    position: fixed; left: ${Math.random()*100}vw; bottom: -50px; 
                    font-size: ${20+Math.random()*30}px; z-index: 200; pointer-events: none;
                    animation: heartBurst 0.5s, floatUp ${2+Math.random()}s ease-out forwards;
                `;
                document.body.appendChild(h);
                // Simple float keyframe injection if needed, or rely on existing style
                h.animate([
                    { transform: 'translateY(0) scale(1)', opacity: 1 },
                    { transform: 'translateY(-100vh) scale(1.5)', opacity: 0 }
                ], { duration: 3000, easing: 'ease-out' }).onfinish = () => h.remove();
            }
        }
        function sendNudge() {
            triggerVibrate();
            channel.send({ type: 'broadcast', event: 'nudge', payload: {} });
        }
        function triggerVibrate() {
            if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
            document.body.animate([
                { transform: 'translateX(0)' },
                { transform: 'translateX(-5px)' },
                { transform: 'translateX(5px)' },
                { transform: 'translateX(0)' }
            ], { duration: 200 });
        }

        // Lightbox
        function openLightbox(url) {
            document.getElementById('lightbox-img').src = url;
            document.getElementById('lightbox').style.display = 'flex';
        }

        // Form Submit
        document.getElementById('chat-form').onsubmit = (e) => {
            e.preventDefault();
            const txt = document.getElementById('msg-input').value.trim();
            if(txt) sendMessage(txt);
        };
    </script>
</body>
</html>
