<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Chat Master</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body { background:#03050a;color:#f1f5f9;font-family:Inter,system-ui;height:100vh;margin:0 }
#messages { overflow-y:auto; flex:1; padding:16px }
.msg { max-width:85%; padding:12px 14px 28px; border-radius:18px; position:relative }
.me { background:#1e293b; align-self:flex-end }
.you { background:#0f172a; align-self:flex-start }
.ts { position:absolute; bottom:6px; right:10px; font-size:9px; opacity:.4 }
.day { text-align:center; font-size:10px; opacity:.4; margin:12px 0 }
.reactions span { font-size:14px }
</style>
</head>

<body class="flex flex-col">

<header class="p-3 bg-black/40 flex justify-between items-center">
  <div>
    <div id="partner-name" class="font-bold">...</div>
    <div id="typing" class="text-xs opacity-50"></div>
  </div>
  <button onclick="openSidebar()">☰</button>
</header>

<main id="messages">
  <button onclick="loadMessages(true)" class="mx-auto block text-xs opacity-40 mb-2">
    Load older messages
  </button>
</main>

<form id="chat-form" class="p-3 flex gap-2 bg-[#0d111c]">
  <input id="msg" class="flex-1 bg-transparent outline-none" placeholder="Message…">
  <button class="bg-blue-600 px-4 rounded-full text-xs">Send</button>
</form>

<!-- SIDEBAR -->
<div id="sidebar" class="fixed inset-y-0 left-[-280px] w-[260px] bg-[#080c14] p-4 transition-all">
  <h2 class="font-bold mb-3">RJ Tools</h2>
  <input id="search" placeholder="Search messages…" class="w-full p-2 text-xs bg-black/40 rounded"
    oninput="searchMessages(this.value)">
</div>

<script>
const SB_URL = 'https://jwfgaulakwiwextmqbov.supabase.co';
const SB_KEY = 'YOUR_ANON_KEY';
const db = supabase.createClient(SB_URL, SB_KEY);

let me, you;
let page = 0;
const PAGE = 40;
let cache = [];
let replyTo = null;

async function init() {
  const code = localStorage.getItem('code') || prompt('Code');
  const { data } = await db.from('chat_codes').select('*').eq('code', code).single();
  if (!data) return alert('Invalid');

  me = data.username;
  you = me === 'RJ' ? 'Allyvia' : 'RJ';
  document.getElementById('partner-name').textContent = you;
  localStorage.setItem('code', code);

  loadMessages();
}

async function loadMessages(more=false) {
  if (more) page++;

  const { data } = await db.from('private_messages')
    .select('*')
    .order('created_at', { ascending:false })
    .range(page*PAGE,(page+1)*PAGE-1);

  if (!data) return;

  const msgs = data.reverse();
  cache = more ? [...msgs,...cache] : msgs;
  render(cache);
}

function render(list) {
  let html = '';
  let lastDay = null;

  list.forEach(m => {
    const day = new Date(m.created_at).toDateString();
    if (day !== lastDay) {
      html += `<div class="day">${day}</div>`;
      lastDay = day;
    }

    const del = m.deleted
      ? `<i class="opacity-40">Message deleted</i>`
      : `<div>${m.message||''}</div>`;

    html += `
    <div class="flex flex-col ${m.sender===me?'items-end':'items-start'} mb-2">
      <div class="msg ${m.sender===me?'me':'you'}">
        ${del}
        <div class="reactions mt-1">
          ${(Object.entries(m.reactions||{})).map(r=>`<span>${r[0]} ${r[1]}</span>`).join('')}
          <button onclick="react('${m.id}','❤️')">➕</button>
        </div>
        <span class="ts">
          ${m.seen_at?'Seen':m.delivered_at?'Delivered':''}
        </span>
      </div>
      ${m.sender===me?`<button onclick="delMsg('${m.id}')" class="text-xs opacity-30">Delete</button>`:''}
    </div>`;
  });

  document.getElementById('messages').innerHTML = html;
}

async function sendMsg(txt) {
  await db.from('private_messages').insert([{
    sender:me, receiver:you, message:txt
  }]);
  document.getElementById('msg').value='';
  page=0;
  loadMessages();
}

async function delMsg(id) {
  await db.from('private_messages').update({deleted:true}).eq('id',id);
  loadMessages();
}

async function react(id,e) {
  const m = cache.find(x=>x.id===id);
  const r = m.reactions||{};
  r[e]=(r[e]||0)+1;
  await db.from('private_messages').update({reactions:r}).eq('id',id);
  loadMessages();
}

function searchMessages(q) {
  if (!q) return render(cache);
  render(cache.filter(m=>(m.message||'').toLowerCase().includes(q.toLowerCase())));
}

function openSidebar() {
  document.getElementById('sidebar').style.left='0';
}

document.getElementById('chat-form').onsubmit=e=>{
  e.preventDefault();
  const v=msg.value.trim();
  if(v) sendMsg(v);
};

init();
</script>
</body>
</html>
