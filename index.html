<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover"/>
    <title>Midnight v13</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
    <style>
        /* DYNAMIC THEME VARIABLES */
        :root {
            --bg: #03050a;
            --me: #1e293b;
            --you: #0f172a;
            --accent: #3b82f6;
            --text: #f1f5f9;
        }

        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; margin: 0; transition: background 0.5s ease; }
        
        /* LAYOUT */
        #chat-main { display: flex; flex-direction: column; height: 100%; max-width: 600px; margin: 0 auto; position: relative; z-index: 10; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; scroll-behavior: smooth; }
        
        /* BUBBLES */
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 20px; font-size: 15px; line-height: 1.5; position: relative; word-wrap: break-word; animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .msg.sent { align-self: flex-end; background: var(--me); color: white; border-bottom-right-radius: 4px; }
        .msg.received { align-self: flex-start; background: var(--you); color: #e2e8f0; border-bottom-left-radius: 4px; }
        .msg.system { align-self: center; background: rgba(255,255,255,0.05); font-size: 12px; padding: 5px 15px; border-radius: 10px; opacity: 0.7; max-width: 95%; text-align: center; }
        
        /* AVATARS */
        .avatar-head { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); transition: border-color 0.5s; }
        .avatar-side { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 0 auto 10px auto; border: 2px solid var(--accent); display: block; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }

        /* THEME BUTTONS */
        .theme-btn { width: 100%; padding: 12px; margin-bottom: 8px; border-radius: 12px; font-size: 11px; font-weight: bold; text-transform: uppercase; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); transition: transform 0.1s; }
        .theme-btn:active { transform: scale(0.98); }

        /* INPUT AREA */
        #input-area { padding: 16px; background: rgba(0,0,0,0.3); backdrop-filter: blur(20px); display: flex; gap: 10px; align-items: flex-end; border-top: 1px solid rgba(255,255,255,0.05); }
        textarea { flex: 1; background: rgba(255,255,255,0.05); border: none; border-radius: 20px; padding: 12px 16px; color: white; font-size: 15px; max-height: 120px; resize: none; outline: none; }
        
        /* HEARTS */
        .heart-float { position: fixed; font-size: 24px; animation: floatUp 3s linear forwards; pointer-events: none; z-index: 1000; }
        @keyframes floatUp { 0% { transform: translateY(100vh) scale(0.5); opacity: 1; } 100% { transform: translateY(-10vh) scale(1.5); opacity: 0; } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* OTHER UI */
        #sidebar { position: fixed; top: 0; left: -320px; width: 300px; height: 100%; background: #0b0f19; z-index: 50; transition: left 0.3s ease; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.05); }
        #overlay-bg { position: fixed; inset: 0; background: black; opacity: 0.5; z-index: 40; }
        .hidden { display: none !important; }
        
        /* MEDIA GRID */
        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 5px; margin-top: 5px; }
        .media-item { width: 100%; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer; background: #000; }
    </style>
</head>
<body>

<div id="login-overlay" class="fixed inset-0 bg-black z-50 flex items-center justify-center p-6">
    <div class="w-full max-w-sm space-y-4">
        <h1 class="text-3xl font-black text-center mb-8 tracking-tighter">MIDNIGHT <span class="text-blue-500">v13</span></h1>
        <input id="login-key" type="password" placeholder="Access Key" class="w-full bg-white/10 p-4 rounded-xl text-center text-xl outline-none border border-white/5 focus:border-blue-500 transition">
        <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-500 p-4 rounded-xl font-bold uppercase tracking-widest transition">Enter</button>
    </div>
</div>

<div id="call-ui" class="hidden fixed inset-0 bg-black z-[60] flex flex-col">
    <div id="remote-video" class="flex-1 bg-gray-900 relative">
        <p class="absolute inset-0 flex items-center justify-center text-white/20 font-bold uppercase tracking-widest">Waiting for video...</p>
    </div>
    <div class="h-1/3 bg-black relative">
        <div id="local-video" class="absolute top-4 right-4 w-32 h-48 bg-gray-800 rounded-xl overflow-hidden border border-white/20 shadow-2xl z-10"></div>
        <div class="absolute bottom-10 left-0 right-0 flex justify-center gap-6">
            <button onclick="toggleMute()" id="mute-btn" class="p-4 bg-white/10 rounded-full backdrop-blur">üé§</button>
            <button onclick="leaveCall()" class="p-4 bg-red-600 rounded-full shadow-lg hover:scale-110 transition">üìû End</button>
            <button onclick="toggleCam()" id="cam-btn" class="p-4 bg-white/10 rounded-full backdrop-blur">üì∑</button>
        </div>
    </div>
</div>

<div id="lightbox" class="hidden fixed inset-0 bg-black/95 z-[70] items-center justify-center p-4" onclick="this.style.display='none'">
    <img id="lightbox-img" class="max-w-full max-h-full rounded shadow-2xl">
</div>

<div id="overlay-bg" class="hidden" onclick="closeSidebar()"></div>
<div id="sidebar">
    <div class="flex-1 space-y-6 overflow-y-auto custom-scrollbar">
        <div class="text-center">
            <label class="cursor-pointer relative group inline-block">
                <img id="my-avatar-preview" src="https://ui-avatars.com/api/?name=Me" class="avatar-side">
                <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-[8px] uppercase font-bold text-white">Upload</div>
                <input type="file" class="hidden" accept="image/*" onchange="uploadAvatar(this)">
            </label>
            <h2 id="me-name" class="text-xl font-bold mt-2">...</h2>
        </div>

        <div class="bg-white/5 p-4 rounded-2xl space-y-3">
            <p class="text-[10px] font-bold opacity-40 uppercase tracking-widest">Status</p>
            <input id="status-txt-input" placeholder="Set status..." class="w-full bg-black/40 p-3 rounded-xl text-xs outline-none border border-white/5 text-white">
            <div class="grid grid-cols-2 gap-2">
                <button onclick="updateStatusFromSidebar()" class="bg-[var(--accent)] p-2 rounded-lg text-[10px] font-bold uppercase text-white">Update</button>
                <label class="bg-white/5 p-2 rounded-lg text-[10px] text-center cursor-pointer border border-dashed border-white/20 text-gray-400">Add Media<input type="file" id="status-media-input" class="hidden" accept="image/*,video/*" multiple onchange="updateStatusFromSidebar()"></label>
            </div>
        </div>

        <div class="bg-white/5 p-4 rounded-2xl">
            <p class="text-[10px] font-bold opacity-40 uppercase tracking-widest mb-3">Mutual Themes</p>
            <button onclick="setTheme('midnight')" class="theme-btn" style="background: #03050a; color: #3b82f6;">Midnight Blue</button>
            <button onclick="setTheme('sunset')" class="theme-btn" style="background: #2a1b1b; color: #f43f5e;">Sunset Rose</button>
            <button onclick="setTheme('forest')" class="theme-btn" style="background: #051a10; color: #10b981;">Deep Forest</button>
            <button onclick="setTheme('lavender')" class="theme-btn" style="background: #1e1b2e; color: #a78bfa;">Soft Lavender</button>
        </div>

        <div class="grid grid-cols-2 gap-2">
            <button onclick="sendInteraction('lovetap')" class="p-4 bg-pink-600/20 text-pink-400 rounded-2xl font-bold text-center hover:bg-pink-600/30 transition">‚ù§Ô∏è Love</button>
            <button onclick="sendInteraction('vibrate')" class="p-4 bg-[var(--accent)]/20 text-[var(--accent)] rounded-2xl font-bold text-center">üì≥ Buzz</button>
        </div>

        <button onclick="toggleGallery(true)" class="w-full text-left p-4 bg-white/5 rounded-2xl">üñºÔ∏è Gallery</button>
        <button onclick="viewDeletedLogs()" class="w-full text-left p-4 bg-white/5 rounded-2xl text-red-400">üóëÔ∏è Logs</button>
    </div>
    <div id="clocks" class="text-[10px] text-center opacity-30 font-mono mt-4"></div>
</div>

<div id="chat-main">
    <div class="flex items-center justify-between p-4 bg-opacity-80 backdrop-blur-md sticky top-0 z-20 border-b border-white/5">
        <div class="flex items-center gap-3">
            <button onclick="openSidebar()" class="text-2xl hover:text-[var(--accent)] transition">‚ò∞</button>
            
            <div class="relative cursor-pointer" onclick="handleStatusClick()">
                <img id="partner-avatar" src="https://ui-avatars.com/api/?name=?" class="avatar-head hidden">
                <span id="partner-online" class="absolute bottom-0 right-0 w-3 h-3 bg-gray-500 rounded-full border-2 border-[var(--bg)]"></span>
            </div>
            
            <div onclick="handleStatusClick()" class="cursor-pointer">
                <div class="font-bold text-lg leading-none" id="partner-name">...</div>
                <div id="partner-status" class="text-[11px] opacity-60">Offline</div>
                <div id="live-preview" class="text-[9px] text-[var(--accent)] italic h-2 transition-all"></div>
            </div>
        </div>
        <div class="flex gap-4">
            <button onclick="startCall('audio')" class="p-2 bg-white/5 rounded-full">üìû</button>
            <button onclick="startCall('video')" class="p-2 bg-white/5 rounded-full">üìπ</button>
        </div>
    </div>

    <div id="messages"></div>

    <div id="reply-box" class="hidden px-4 py-2 bg-white/5 text-xs flex justify-between items-center border-l-4 border-[var(--accent)] mx-4 mb-0 rounded-t-lg">
        <span id="reply-text" class="opacity-70 truncate max-w-[80%]">Replying...</span>
        <button onclick="cancelReply()" class="font-bold hover:text-red-500">‚úï</button>
    </div>

    <form id="chat-form" class="mt-auto">
        <div id="file-preview-area" class="hidden flex gap-2 px-4 pb-2 overflow-x-auto"></div>
        
        <div id="input-area">
            <label class="cursor-pointer p-2 text-gray-400 hover:text-white transition">
                üìé <input type="file" multiple class="hidden" onchange="handleFileSelect(this)">
            </label>
            <textarea id="msg-input" rows="1" placeholder="Type a message..."></textarea>
            <button type="submit" class="p-3 bg-[var(--accent)] rounded-xl font-bold text-white shadow-lg hover:brightness-110 transition">‚û§</button>
        </div>
    </form>
</div>

<script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = 'https://jwfgaulakwiwextmqbov.supabase.co'; // ‚ö†Ô∏è PUT YOUR URL HERE
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3ZmdhdWxha3dpd2V4dG1xYm92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NzU1MTYsImV4cCI6MjA4MjI1MTUxNn0.DBOoI_wLNGyB1LLfXzyAbVvEkVMj9XcCJie-HAZ0_d4'; // ‚ö†Ô∏è PUT YOUR KEY HERE
    const AGORA_APP_ID = '4f6c6c2002784152a8366dec12f1b4c0'; // ‚ö†Ô∏è PUT YOUR AGORA ID HERE
    
    // --- VARIABLES ---
    const _db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let me = localStorage.getItem('chat_user') || '';
    let you = '';
    let chatChannel, callClient, localTracks = [], remoteUsers = {};
    let replyId = null, stagedFiles = [], partnerStatusData = null;
    let callStartTime = 0; // For call logging

    // --- HEART SPAM LIMITER ---
    let heartsLastMinute = 0;
    setInterval(() => { heartsLastMinute = 0; }, 60000); // Reset every minute

    // --- THEMES ---
    const themes = {
        midnight: { bg: '#03050a', me: '#1e293b', you: '#0f172a', accent: '#3b82f6' },
        sunset:   { bg: '#1c1014', me: '#3f1a20', you: '#2a1216', accent: '#f43f5e' },
        forest:   { bg: '#020e07', me: '#0c2e1e', you: '#051a10', accent: '#10b981' },
        lavender: { bg: '#1e1b2e', me: '#4c1d95', you: '#2e1065', accent: '#a78bfa' }
    };

    // --- INITIALIZATION ---
    window.onload = () => {
        // Clear stuck hearts on load
        document.querySelectorAll('.heart-float').forEach(el => el.remove());

        if(!me) document.getElementById('login-overlay').classList.remove('hidden');
        else init();
        
        setInterval(updateClocks, 1000);
        
        // Auto-resize textarea
        const tx = document.getElementById('msg-input');
        tx.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value === '') this.style.height = 'auto';
        });
        
        // Enter to send
        tx.addEventListener('keydown', function(e) {
            if(e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('chat-form').dispatchEvent(new Event('submit'));
            }
        });
    };

   async function login() {
    const key = document.getElementById('login-key').value;
    console.log("Attempting login with key:", key);

    const { data, error } = await _db
        .from('chat_codes')
        .select('*')
        .eq('access_code', key)
        .single();
    
    if (error) {
        console.error("Supabase Error:", error.message);
        alert("Database Error: " + error.message);
        return;
    }

    if (data) {
        console.log("Login success! Data:", data);
        me = data.username;
        you = data.pair_with;
        localStorage.setItem('chat_user', me);
        document.getElementById('login-overlay').classList.add('hidden');
        init();
    } else {
        alert('Invalid Key - No match found in database.');
    }
}

    async function init() {
        document.getElementById('me-name').innerText = me;
        
        // Load history
        const { data: msgs } = await _db.from('messages').select('*').or(`sender.eq.${me},receiver.eq.${me}`).order('created_at', { ascending: false }).limit(50);
        if(msgs) msgs.reverse().forEach(renderMessage);

        // Load Status/Avatar/Theme
        loadStatuses();

        // Realtime
        chatChannel = _db.channel('chat_room')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                if((payload.new.sender === you && payload.new.receiver === me) || (payload.new.sender === me)) {
                    renderMessage(payload.new);
                    if(payload.new.sender === you) notify();
                }
            })
            .on('broadcast', { event: 'admin' }, ({ payload }) => handleInteraction(payload))
            .on('broadcast', { event: 'typing' }, ({ payload }) => {
                const p = document.getElementById('live-preview');
                if(payload.from === you) {
                    p.innerText = payload.txt ? `${you} is typing: ${payload.txt}...` : '';
                    setTimeout(() => p.innerText = '', 3000);
                }
            })
            .on('presence', { event: 'sync' }, () => {
                const state = chatChannel.presenceState();
                const online = Object.values(state).flat().some(u => u.user === you);
                document.getElementById('partner-online').className = `absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-[var(--bg)] ${online ? 'bg-green-500' : 'bg-gray-500'}`;
            })
            .subscribe(async (status) => {
                if(status === 'SUBSCRIBED') await chatChannel.track({ user: me, online_at: new Date() });
            });
            
        // Agora Setup
        callClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
        callClient.on("user-published", handleUserPublished);
        callClient.on("user-unpublished", handleUserUnpublished);
    }

    // --- THEME & AVATAR LOGIC ---
    
    async function uploadAvatar(input) {
        const file = input.files[0];
        if(!file) return;

        // 1. Upload to Supabase Storage
        const fileName = `avatar_${me}_${Date.now()}.jpg`;
        const { error: upErr } = await _db.storage.from('avatars').upload(fileName, file);
        if(upErr) { alert('Upload failed'); return; }

        // 2. Get URL
        const { data: { publicUrl } } = _db.storage.from('avatars').getPublicUrl(fileName);

        // 3. Save to DB
        await _db.from('chat_codes').update({ avatar_url: publicUrl }).eq('username', me);
        
        // 4. Update UI & Notify
        document.getElementById('my-avatar-preview').src = publicUrl;
        chatChannel.send({ type: 'broadcast', event: 'admin', payload: { type: 'profile_update' } });
    }

    async function setTheme(name) {
        // Apply locally
        applyTheme(name);
        // Save to DB
        await _db.from('chat_codes').update({ theme: name }).eq('username', me);
        // Broadcast
        chatChannel.send({ type: 'broadcast', event: 'admin', payload: { type: 'theme_change', theme: name } });
    }

    function applyTheme(name) {
        const t = themes[name] || themes.midnight;
        const root = document.documentElement.style;
        root.setProperty('--bg', t.bg);
        root.setProperty('--me', t.me);
        root.setProperty('--you', t.you);
        root.setProperty('--accent', t.accent);
    }

    // --- INTERACTION HANDLING ---

    function sendInteraction(type) {
        // Fix: Heart Limit
        if (type === 'lovetap') {
            if (heartsLastMinute >= 40) {
                alert("Too much love! Wait a moment.");
                return;
            }
            heartsLastMinute++;
        }
        
        chatChannel.send({ 
            type: 'broadcast', 
            event: 'admin', 
            payload: { type: type, from: me } 
        });
    }

    function handleInteraction(p) {
        if (p.type === 'profile_update') {
            loadStatuses(); // Reload avatars
        }
        else if (p.type === 'theme_change') {
            applyTheme(p.theme);
        }
        else if (p.type === 'vibrate') {
            if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }
        else if (p.type === 'lovetap') {
            // Screen clutter protection
            if (document.querySelectorAll('.heart-float').length > 30) return; 

            for(let i=0; i<10; i++) {
                const h = document.createElement('div');
                h.className = 'heart-float';
                h.style.left = Math.random() * 90 + 'vw';
                h.innerText = '‚ù§Ô∏è';
                h.style.animationDuration = (2 + Math.random() * 2) + 's';
                document.body.appendChild(h);
                setTimeout(() => h.remove(), 4000);
            }
        }
        else if (p.type === 'call_start') {
            if (confirm('Incoming call from ' + p.from + '. Join?')) joinCall(p.channel, p.mode);
        }
    }

    async function loadStatuses() {
        const { data } = await _db.from('chat_codes').select('*');
        if(!data) return;

        // My Data
        const myData = data.find(u => u.username === me);
        if(myData && myData.avatar_url) document.getElementById('my-avatar-preview').src = myData.avatar_url;
        if(myData && myData.theme) applyTheme(myData.theme);

        // Partner Data
        const p = data.find(u => u.username === you);
        if(p) {
            partnerStatusData = p;
            document.getElementById('partner-name').innerText = you;
            document.getElementById('partner-status').innerText = p.status_text || "Offline";
            
            // Partner Avatar
            const el = document.getElementById('partner-avatar');
            if (p.avatar_url) {
                el.src = p.avatar_url;
                el.classList.remove('hidden');
            }
            // Sync theme if they updated it recently (optional mutual logic)
            if (p.theme) applyTheme(p.theme); 
        }
    }

    // --- CALL LOGGING & AGORA ---

    async function startCall(mode) {
        const channelName = 'call_' + Math.random().toString(36).substr(2, 9);
        await joinCall(channelName, mode);
        chatChannel.send({ type: 'broadcast', event: 'admin', payload: { type: 'call_start', from: me, channel: channelName, mode: mode } });
    }

    async function joinCall(channel, mode) {
        callStartTime = Date.now(); // Start Timer
        document.getElementById('call-ui').classList.remove('hidden');
        
        await callClient.join(AGORA_APP_ID, channel, null, me);
        
        if (mode === 'video') {
            localTracks = await AgoraRTC.createMicrophoneAndCameraTracks();
            localTracks[1].play('local-video');
            document.getElementById('local-video').classList.remove('hidden');
        } else {
            localTracks = await AgoraRTC.createMicrophoneAndCameraTracks(); // simplified for audio
            localTracks[1].setEnabled(false); // Disable cam for audio call
            document.getElementById('local-video').classList.add('hidden');
        }
        
        await callClient.publish(localTracks);
    }

    async function leaveCall() {
        for (let track of localTracks) { track.stop(); track.close(); }
        await callClient.leave();
        document.getElementById('call-ui').classList.add('hidden');
        
        // --- CALL LOGGING ---
        if (callStartTime > 0) {
            const durationMs = Date.now() - callStartTime;
            const minutes = Math.floor(durationMs / 60000);
            const seconds = ((durationMs % 60000) / 1000).toFixed(0);
            const timeStr = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            
            // Send System Message to Database
            const sysMsg = `üìû Call ended. Duration: ${timeStr}`;
            await _db.from('messages').insert({
                sender: me, receiver: you, content: sysMsg, type: 'system'
            });
            callStartTime = 0;
        }
    }

    function handleUserPublished(user, mediaType) {
        callClient.subscribe(user, mediaType).then(() => {
            if (mediaType === 'video') user.videoTrack.play('remote-video');
            if (mediaType === 'audio') user.audioTrack.play();
        });
    }
    
    function handleUserUnpublished(user) {
        // partner left
    }
    
    function toggleMute() {
        if(localTracks[0]) {
            const enabled = localTracks[0].enabled;
            localTracks[0].setEnabled(!enabled);
            document.getElementById('mute-btn').style.background = enabled ? 'red' : 'rgba(255,255,255,0.1)';
        }
    }
    
    function toggleCam() {
        if(localTracks[1]) {
            const enabled = localTracks[1].enabled;
            localTracks[1].setEnabled(!enabled);
            document.getElementById('cam-btn').style.background = enabled ? 'red' : 'rgba(255,255,255,0.1)';
        }
    }

    // --- MESSAGING ---

    async function sendMsg(txt) {
        if(!txt && stagedFiles.length === 0) return;
        
        // Upload files first if any
        let attachments = [];
        if(stagedFiles.length > 0) {
            for(let file of stagedFiles) {
                const fname = `chat_${Date.now()}_${file.name}`;
                await _db.storage.from('chat-files').upload(fname, file);
                const { data } = _db.storage.from('chat-files').getPublicUrl(fname);
                attachments.push({ type: file.type.startsWith('image') ? 'img' : 'file', url: data.publicUrl });
            }
        }
        
        const payload = {
            sender: me, 
            receiver: you, 
            content: txt, 
            reply_to: replyId,
            media: attachments.length ? attachments : null
        };
        
        await _db.from('messages').insert(payload);
        
        document.getElementById('msg-input').value = '';
        document.getElementById('msg-input').style.height = 'auto';
        cancelReply();
        stagedFiles = [];
        document.getElementById('file-preview-area').innerHTML = '';
        document.getElementById('file-preview-area').classList.add('hidden');
    }

    function renderMessage(msg) {
        const div = document.createElement('div');
        const isMe = msg.sender === me;
        
        // Check for System Message (Call Logs)
        if (msg.type === 'system') {
            div.className = 'msg system';
            div.innerText = msg.content + ` (${new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})})`;
        } else {
            // Normal Message
            div.className = `msg ${isMe ? 'sent' : 'received'}`;
            
            // Reply Preview
            if(msg.reply_to) {
                // In a real app, you'd fetch the reply text. For now, simple indicator:
                div.innerHTML += `<div class="text-[10px] opacity-50 mb-1 border-l-2 pl-2 border-white">Replying...</div>`;
            }

            // Text
            if(msg.content) div.innerHTML += linkify(msg.content);
            
            // Media
            if(msg.media && Array.isArray(msg.media)) {
                msg.media.forEach(m => {
                    if(m.type === 'img') div.innerHTML += `<br><img src="${m.url}" class="mt-2 rounded-lg max-w-full cursor-pointer" onclick="openLightbox('${m.url}')">`;
                    else div.innerHTML += `<br><a href="${m.url}" target="_blank" class="text-xs underline mt-1 block">üìé Attachment</a>`;
                });
            }
            
            // Timestamp
            const time = new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            div.innerHTML += `<div class="text-[9px] text-right opacity-50 mt-1">${time}</div>`;
            
            // Actions
            if(!isMe) div.ondblclick = () => setReply(msg.id, msg.content || 'Media');
            if(isMe) div.oncontextmenu = (e) => { e.preventDefault(); deleteMsg(msg.id); };
        }
        
        const c = document.getElementById('messages');
        c.appendChild(div);
        c.scrollTop = c.scrollHeight;
    }

    // --- UTILS ---
    function handleFileSelect(input) {
        stagedFiles = Array.from(input.files);
        const area = document.getElementById('file-preview-area');
        area.innerHTML = '';
        area.classList.remove('hidden');
        stagedFiles.forEach(f => {
            const span = document.createElement('span');
            span.className = "text-xs bg-white/10 p-1 rounded whitespace-nowrap";
            span.innerText = f.name;
            area.appendChild(span);
        });
    }

    function linkify(text) {
        return text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="underline text-blue-300">$1</a>');
    }

    async function deleteMsg(id) {
        if(confirm('Delete message?')) {
            await _db.from('messages').delete().eq('id', id);
            location.reload(); // Simple refresh to clear
        }
    }
    
    function setReply(id, txt) {
        replyId = id;
        document.getElementById('reply-text').innerText = "Replying to: " + txt;
        document.getElementById('reply-box').classList.remove('hidden');
    }
    
    function cancelReply() {
        replyId = null;
        document.getElementById('reply-box').classList.add('hidden');
    }
    
    function notify() {
        const a = new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3');
        a.volume = 0.5;
        a.play().catch(() => {});
        if(navigator.vibrate) navigator.vibrate(200);
    }

    // --- SIDEBAR & STATUS ---
    async function updateStatusFromSidebar() {
        const txt = document.getElementById('status-txt-input').value;
        const mediaInput = document.getElementById('status-media-input');
        
        // Handle media uploads similar to avatar/chat files...
        // For brevity: Update text immediately
        await _db.from('chat_codes').update({ status_text: txt }).eq('username', me);
        chatChannel.send({ type: 'broadcast', event: 'admin', payload: { type: 'profile_update' } });
    }
    
    function handleStatusClick() {
        if(partnerStatusData) {
            // Logic to show story viewer...
            // For now, just alert text
            alert(partnerStatusData.status_text || "No status set");
        }
    }
    
    function openLightbox(u) { document.getElementById('lightbox-img').src = u; document.getElementById('lightbox').style.display = 'flex'; }
    function openSidebar() { document.getElementById('sidebar').style.left = '0'; document.getElementById('overlay-bg').classList.remove('hidden'); }
    function closeSidebar() { document.getElementById('sidebar').style.left = '-320px'; document.getElementById('overlay-bg').classList.add('hidden'); }
    
    function updateClocks() {
        const o = { hour: '2-digit', minute: '2-digit', hour12: true };
        document.getElementById('clocks').innerHTML = `
            Brisbane: ${new Date().toLocaleTimeString('en-US', { ...o, timeZone: 'Australia/Brisbane' })}<br>
            Local: ${new Date().toLocaleTimeString('en-US', { ...o })}
        `;
    }
</script>
</body>
</html>
