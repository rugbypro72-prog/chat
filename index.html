<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover"/>
    <title>MidNight v2.0 | Private</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
    
    <style>
        /* --- THEME ENGINE ---
           Variables defined for dynamic theme switching 
           between 'Default' and 'Love' modes.
        */
        :root { 
            --bg: #03050a; 
            --me-bg: #1e293b; 
            --you-bg: #0f172a; 
            --accent: #3b82f6; 
            --text: #f1f5f9; 
            --sidebar-bg: #080c14;
            --msg-border: rgba(255,255,255,0.1);
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body.theme-love {
            --bg: #1a0b12; 
            --me-bg: #5c1e3a; 
            --you-bg: #361121; 
            --accent: #ec4899; 
            --sidebar-bg: #260f19;
            --msg-border: rgba(236, 72, 153, 0.3);
        }

        /* --- CORE BASE STYLES ---
        */
        body { 
            background-color: var(--bg); 
            color: var(--text); 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            height: 100vh; 
            overflow: hidden; 
            margin: 0; 
            transition: background-color 0.5s ease, color 0.5s ease;
            background-size: cover;
            background-position: center; 
            background-attachment: fixed;
        }

        /* --- LAYOUT ARCHITECTURE ---
        */
        #chat-main { 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
            max-width: 600px; 
            margin: 0 auto; 
            position: relative; 
            z-index: 10; 
        }

        #messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 16px; 
            scroll-behavior: smooth; 
            scrollbar-width: none; /* Firefox */
        }

        #messages::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        /* --- MESSAGE BUBBLES ---
        */
        .avatar { 
            width: 35px; 
            height: 35px; 
            border-radius: 50%; 
            object-fit: cover; 
            flex-shrink: 0; 
            border: 2px solid var(--msg-border); 
        }

        .msg-wrap { 
            display: flex; 
            gap: 10px; 
            width: 100%; 
            position: relative; 
            align-items: flex-end; 
        }

        .row-me { 
            flex-direction: row-reverse; 
        } 
        
        .bubble { 
            max-width: 80%; 
            padding: 12px 14px 26px 14px; 
            font-size: 15px; 
            border-radius: 20px; 
            position: relative; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            word-wrap: break-word;
            transition: background-color 0.3s ease; 
        }

        .me { 
            background: var(--me-bg); 
            border: 1px solid var(--msg-border); 
            border-bottom-right-radius: 4px; 
        }

        .you { 
            background: var(--you-bg); 
            border: 1px solid var(--msg-border); 
            border-bottom-left-radius: 4px; 
        }
        
        .ts-inside { 
            position: absolute; 
            bottom: 6px; 
            right: 12px; 
            font-size: 9px; 
            opacity: 0.6; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 4px; 
        }

        .reply-preview { 
            font-size: 11px; 
            background: rgba(0,0,0,0.2); 
            padding: 8px; 
            border-radius: 12px;
            border-left: 3px solid var(--accent); 
            margin-bottom: 8px; 
            opacity: 0.9; 
            display: block; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }

        /* --- RAIN SYSTEM ---
        */
        .rain-item { 
            position: fixed; 
            top: -100px; 
            z-index: 9999; 
            pointer-events: none; 
            animation: fall linear forwards; 
        }

        @keyframes fall { 
            0% { transform: translateY(0vh) rotate(0deg); }
            100% { transform: translateY(110vh) rotate(360deg); } 
        }

        /* --- MODALS & OVERLAYS ---
        */
        .modal-view { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: var(--bg); 
            z-index: 2000; 
            overflow-y: auto; 
            padding: 25px; 
            animation: fadeIn 0.2s ease; 
        }

        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }
        
        #story-overlay { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: black; 
            z-index: 6000; 
            align-items: center; 
            justify-content: center; 
            flex-direction: column; 
        }

        .story-nav-btn { 
            position: absolute; 
            top: 50%; 
            transform: translateY(-50%); 
            font-size: 3rem; 
            color: white;
            padding: 20px; 
            cursor: pointer; 
            opacity: 0.4; 
            transition: 0.2s; 
            z-index: 6010;
        }

        .story-nav-btn:hover { 
            opacity: 1; 
        }

        #story-prev { left: 0; } 
        #story-next { right: 0; }

        /* --- UI COMPONENTS ---
        */
        #search-bar { 
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(-100%); 
            position: absolute; 
            top: 70px; 
            left: 0; 
            right: 0; 
            z-index: 40; 
            background: var(--bg); 
            padding: 10px; 
            border-bottom: 1px solid var(--msg-border);
            opacity: 0; 
            pointer-events: none; 
        }

        #search-bar.active { 
            transform: translateY(0); 
            opacity: 1; 
            pointer-events: all; 
        }
        
        .call-btn { 
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px); 
            width: 55px; 
            height: 55px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 20px; 
            transition: 0.2s; 
        }

        .call-btn.active { 
            background: var(--accent); 
        }

        #video-grid { 
            position: fixed; 
            inset: 0; 
            background: #000; 
            z-index: 3000; 
            display: none; 
        }

        /* --- TOGGLE SWITCH ---
        */
        .toggle-checkbox:checked { 
            right: 0; 
            border-color: var(--accent); 
        }
        
        .toggle-checkbox:checked + .toggle-label { 
            background-color: var(--accent); 
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>

<div id="story-overlay">
    <div id="story-prev" class="story-nav-btn hidden" onclick="navStory(-1)">‚Äπ</div>
    <div id="story-media-container" class="relative w-full h-full flex items-center justify-center p-4"></div>
    <div class="absolute bottom-10 text-center w-full text-xl font-bold text-white shadow-lg z-[6025]" id="story-caption"></div>
    <div id="story-next" class="story-nav-btn hidden" onclick="navStory(1)">‚Ä∫</div>
    <button onclick="closeStory()" class="absolute top-6 right-6 text-white text-3xl z-[6030] opacity-50 hover:opacity-100 transition">‚úï</button>
</div>

<div id="video-grid">
    <div id="remote-video" class="w-full h-full"></div>
    <div id="local-video" class="absolute top-10 right-6 w-32 h-48 border-2 border-white/20 rounded-2xl overflow-hidden bg-black shadow-2xl z-[3010]"></div>
    <div class="absolute bottom-12 left-0 right-0 flex justify-center gap-6 z-[3020]">
        <button id="btn-mute" onclick="toggleMute()" class="call-btn">üé§</button>
        <button id="btn-cam" onclick="toggleCam()" class="call-btn">üì∑</button>
        <button onclick="endCall()" class="call-btn !bg-red-600 shadow-xl">üìû</button>
    </div>
</div>

<div id="logs-modal" class="modal-view">
    <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl font-black text-red-500 tracking-tighter">DELETED LOGS</h2>
        <button onclick="closeModal('logs-modal')" class="bg-white/10 px-5 py-2 rounded-full text-xs font-bold uppercase">Close</button>
    </div>
    <div id="logs-content" class="space-y-4 pb-24"></div>
</div>

<div id="edits-modal" class="modal-view">
    <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl font-black text-yellow-500 tracking-tighter">EDIT HISTORY</h2>
        <button onclick="closeModal('edits-modal')" class="bg-white/10 px-5 py-2 rounded-full text-xs font-bold uppercase">Close</button>
    </div>
    <div id="edits-content" class="space-y-4 pb-24"></div>
</div>

<div id="story-history-modal" class="modal-view">
    <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl font-black text-pink-500 tracking-tighter">STORY ARCHIVE</h2>
        <button onclick="closeModal('story-history-modal')" class="bg-white/10 px-5 py-2 rounded-full text-xs font-bold uppercase">Close</button>
    </div>
    <div id="story-history-content" class="grid grid-cols-2 gap-4 pb-24"></div>
</div>

<div id="search-bar">
    <div class="flex gap-3 items-center">
        <input type="text" id="search-input" placeholder="Search keywords..." class="flex-1 bg-white/5 rounded-xl p-3 text-sm outline-none border border-white/10 focus:border-blue-500 transition" onkeyup="handleSearch(this.value)">
        <button onclick="toggleSearch()" class="text-white/30 hover:text-white px-2 text-xl">‚úï</button>
    </div>
</div>

<div id="chat-main">
    <header class="p-4 border-b border-white/5 flex items-center justify-between bg-black/20 backdrop-blur-xl z-50">
        <div class="flex items-center gap-4">
            <button onclick="openSidebar()" class="text-2xl opacity-70 hover:opacity-100 transition">‚ò∞</button>
            <div class="relative cursor-pointer group" onclick="handleStatusClick()">
                <img id="header-pfp" class="avatar transition group-hover:scale-105" src="">
                <div id="status-ring" class="absolute -inset-1 rounded-full border-2 border-blue-500 animate-pulse hidden"></div>
            </div>
            <div class="overflow-hidden">
                <div class="font-bold text-md leading-tight tracking-tight" id="partner-name">...</div>
                <div id="partner-status" class="text-[11px] opacity-50 truncate max-w-[150px] font-medium">No status</div>
                <div id="live-preview" class="text-[9px] text-[var(--accent)] italic h-3 font-bold"></div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleSearch()" class="p-2 opacity-50 hover:opacity-100 transition">üîç</button>
            <button onclick="initCall(true)" class="p-2 px-5 bg-blue-600 rounded-full text-[10px] font-black tracking-widest uppercase shadow-lg shadow-blue-600/20">VIDEO</button>
        </div>
    </header>

    <main id="messages"></main>

    <footer class="p-4 bg-transparent">
        <div id="staging-area" class="grid grid-cols-4 gap-2 mb-3 empty:hidden"></div>
        
        <div id="reply-box" class="hidden bg-blue-500/10 p-4 rounded-t-2xl border-l-4 border-blue-600 flex justify-between items-center mb-[-10px] pb-6 backdrop-blur-md">
            <div class="overflow-hidden">
                <p class="text-[9px] font-black text-blue-500 uppercase tracking-widest mb-1">Replying to</p>
                <p id="reply-text" class="text-[11px] italic opacity-70 truncate"></p>
            </div>
            <button onclick="cancelReply()" class="p-2 opacity-40 hover:opacity-100">‚úï</button>
        </div>

        <div id="edit-box" class="hidden bg-yellow-500/10 p-4 rounded-t-2xl border-l-4 border-yellow-600 flex justify-between items-center mb-[-10px] pb-6 backdrop-blur-md">
            <div>
                <p class="text-[9px] font-black text-yellow-500 uppercase tracking-widest mb-1">Editing Mode</p>
                <p class="text-[11px] text-yellow-200/60 italic">Adjusting your message...</p>
            </div>
            <button onclick="cancelEdit()" class="p-2 opacity-40 hover:opacity-100">‚úï</button>
        </div>

        <form id="chat-form" class="flex items-center bg-black/50 border border-white/10 rounded-full p-1.5 pl-5 shadow-2xl backdrop-blur-2xl">
            <label class="cursor-pointer opacity-40 hover:opacity-100 p-2 transition">
                üìé<input type="file" id="file-input" class="hidden" multiple accept="image/*" onchange="handleFileSelect(this)">
            </label>
            <input id="msg-input" placeholder="Say something..." autocomplete="off" class="flex-1 bg-transparent py-3.5 px-3 text-sm outline-none font-medium">
            <button type="submit" id="send-btn" class="bg-blue-600 text-white font-black px-8 py-3.5 rounded-full text-[11px] tracking-widest uppercase transition-all active:scale-95 shadow-lg shadow-blue-600/20">SEND</button>
        </form>
    </footer>
</div>

<div id="sidebar" class="fixed left-[-300px] top-0 bottom-0 w-[290px] bg-[var(--sidebar-bg)] z-[1000] p-8 flex flex-col transition-all duration-500 cubic-bezier(0.4, 0, 0.2, 1) border-r border-white/5 shadow-2xl">
    <div class="mb-10 text-center">
        <h1 class="text-[var(--accent)] font-black text-3xl tracking-tighter">MidNight</h1>
        <div class="h-1 w-12 bg-[var(--accent)] mx-auto mt-2 rounded-full opacity-30"></div>
        <p class="text-[9px] opacity-30 tracking-[0.3em] uppercase mt-3 font-black">Private Build v2.0</p>
    </div>

    <div class="flex flex-col items-center mb-10">
        <div class="relative group">
            <img id="my-pfp" class="w-28 h-28 rounded-full border-4 border-white/5 object-cover shadow-2xl transition duration-500 group-hover:border-[var(--accent)]/30">
            <label class="absolute inset-0 flex items-center justify-center bg-black/70 rounded-full opacity-0 group-hover:opacity-100 cursor-pointer transition-all duration-300 backdrop-blur-sm">
                <span class="text-[10px] font-black tracking-widest">UPDATE</span>
                <input type="file" class="hidden" accept="image/*" onchange="uploadPFP(this)">
            </label>
        </div>
        <p id="me-name" class="font-black mt-4 text-xl tracking-tight uppercase"></p>
        <div id="days-counter" class="text-[10px] text-[var(--accent)] font-black bg-[var(--accent)]/10 px-6 py-2 rounded-full mt-4 tracking-widest border border-[var(--accent)]/20 shadow-sm">...</div>
    </div>

    <div class="flex-1 space-y-6 overflow-y-auto no-scrollbar">
        <button onclick="rainPrompt()" class="w-full p-5 bg-blue-500/10 text-blue-400 rounded-3xl font-black text-[11px] uppercase tracking-widest flex items-center justify-between transition-all hover:bg-blue-500/20 active:scale-95 border border-blue-500/10">
            <span>üåßÔ∏è Make it Rain</span>
            <span class="opacity-40">‚Ä∫</span>
        </button>
        
        <div class="bg-white/5 p-5 rounded-[2rem] space-y-4 border border-white/5">
            <p class="text-[10px] font-black opacity-30 uppercase tracking-[0.2em]">Update Story</p>
            <textarea id="status-txt-input" placeholder="Share a thought..." class="w-full bg-black/40 p-4 rounded-2xl text-xs outline-none border border-white/5 resize-none h-20 font-medium focus:border-blue-500/30 transition"></textarea>
            
            <label class="block bg-white/5 p-4 rounded-2xl text-[9px] font-black uppercase tracking-widest text-center cursor-pointer border border-dashed border-white/10 hover:bg-white/10 transition">
                üì∏ Select Media
                <input type="file" id="status-media-input" class="hidden" multiple accept="image/*,video/*">
            </label>
            
            <div class="grid grid-cols-2 gap-3 pt-2">
                <button onclick="updateStatus()" class="bg-blue-600 p-3 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-600/10 transition active:scale-95">Post</button>
                <button onclick="clearStatus()" class="bg-red-600/10 text-red-500 p-3 rounded-xl text-[10px] font-black uppercase tracking-widest border border-red-500/10 transition active:scale-95">Clear</button>
            </div>
        </div>

        <div class="bg-white/5 p-5 rounded-[2rem] space-y-4 border border-white/5">
            <p class="text-[10px] font-black opacity-30 uppercase tracking-[0.2em]">Visuals</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="setTheme('default')" class="text-[9px] font-black p-3 bg-slate-800 rounded-xl uppercase tracking-widest transition hover:brightness-125">Dark</button>
                <button onclick="setTheme('love')" class="text-[9px] font-black p-3 bg-pink-900/50 rounded-xl uppercase tracking-widest border border-pink-500/20 transition hover:bg-pink-900/70">Love</button>
            </div>
            <label class="block w-full text-center text-[9px] font-black p-4 bg-indigo-900/30 rounded-2xl cursor-pointer hover:bg-indigo-900/50 transition border border-indigo-500/10 uppercase tracking-widest">
                Upload Background
                <input type="file" class="hidden" accept="image/*" onchange="uploadBG(this)">
            </label>
        </div>

        <div id="rj-settings" class="hidden bg-white/5 p-5 rounded-[2rem] flex items-center justify-between border border-white/5">
            <span class="text-[10px] font-black opacity-50 uppercase tracking-widest">Read Receipts</span>
            <div class="relative inline-block w-12 h-6 align-middle select-none transition duration-200 ease-in">
                <input type="checkbox" name="toggle" id="receipt-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-2 border-transparent appearance-none cursor-pointer transition-all duration-300 ease-in-out shadow-lg"/>
                <label for="receipt-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-zinc-800 cursor-pointer transition-all duration-300"></label>
            </div>
        </div>

        <button onclick="launchPiP()" class="w-full p-5 bg-white/5 rounded-3xl font-black text-[11px] uppercase tracking-widest text-left hover:bg-white/10 transition border border-white/5">üì∫ External View (PiP)</button>
        
        <div class="grid grid-cols-3 gap-3">
            <button onclick="viewStoryLogs()" class="flex flex-col items-center gap-2 p-4 bg-pink-600/5 text-pink-400 rounded-2xl hover:bg-pink-600/10 transition border border-pink-500/5">
                <span class="text-lg">üìú</span>
                <span class="text-[8px] font-black uppercase">Stories</span>
            </button>
            <button onclick="viewEditLogs()" class="flex flex-col items-center gap-2 p-4 bg-yellow-600/5 text-yellow-400 rounded-2xl hover:bg-yellow-600/10 transition border border-yellow-500/5">
                <span class="text-lg">‚úèÔ∏è</span>
                <span class="text-[8px] font-black uppercase">Edits</span>
            </button>
            <button onclick="viewDeletedLogs()" class="flex flex-col items-center gap-2 p-4 bg-red-600/5 text-red-400 rounded-2xl hover:bg-red-600/10 transition border border-red-500/5">
                <span class="text-lg">üóëÔ∏è</span>
                <span class="text-[8px] font-black uppercase">Deleted</span>
            </button>
        </div>
    </div>
</div>

<video id="pip-src" autoplay muted playsinline style="position:fixed; top:-9999px;"></video>
<canvas id="pip-canvas" width="400" height="250" class="hidden"></canvas>
<div id="overlay-bg" onclick="closeSidebar()" class="hidden fixed inset-0 bg-black/80 backdrop-blur-md z-[900] transition-opacity duration-500"></div>

<script>
    /*
       --- CORE CONFIGURATION ---
       Database keys and initialization
    */
    const SB_URL = 'https://jwfgaulakwiwextmqbov.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3ZmdhdWxha3dpd2V4dG1xYm92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NzU1MTYsImV4cCI6MjA4MjI1MTUxNn0.DBOoI_wLNGyB1LLfXzyAbVvEkVMj9XcCJie-HAZ0_d4';
    const _db = supabase.createClient(SB_URL, SB_KEY);
    
    // Global State Variables
    let me, you, chatChannel;
    let stagedFiles = [];
    let allMessages = [];
    let replyId = null;
    let editingId = null;
    let storyItems = [];
    let storyIndex = 0;
    let partnerData = null;
    let myData = null;
    let rtc = { 
        client: null, 
        localVideoTrack: null, 
        localAudioTrack: null,
        isMuted: false,
        isCamOff: false
    };

    // UI Identity Defaults
    const defaults = { 
        'RJ': { bg: '#000', col: '#fff', t: 'R' }, 
        'Allyvia': { bg: '#fef08a', col: '#000', t: 'A' } 
    };

    /**
     * Initializes the application, handles auth, and sets up real-time listeners.
     */
    async function init() {
        const code = localStorage.getItem('chat_secret_code') || prompt("Access Code:");
        
        const { data, error } = await _db.from('chat_codes').select('*').eq('code', code).single();
        
        if (!data) {
            alert("Invalid access code.");
            localStorage.removeItem('chat_secret_code');
            return location.reload();
        }

        me = data.username;
        you = (me === 'RJ' ? 'Allyvia' : 'RJ');
        localStorage.setItem('chat_secret_code', code);
        
        document.getElementById('me-name').textContent = me;

        // Admin-only UI Logic
        if (me === 'RJ') {
            document.getElementById('rj-settings').classList.remove('hidden');
            document.getElementById('receipt-toggle').addEventListener('change', toggleReadReceipts);
        }

        // --- REAL-TIME CHANNEL SETUP ---
        chatChannel = _db.channel('midnight-v2');
        chatChannel
            .on('broadcast', { event: 'sync' }, (p) => handleSync(p.payload))
            .on('broadcast', { event: 'typing' }, (p) => {
                const indicator = document.getElementById('live-preview');
                indicator.textContent = p.payload.text ? `${you} is typing...` : "";
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'private_messages' }, (p) => {
                if (p.eventType === 'INSERT' && p.new.receiver === me) {
                    markAsRead(p.new.id);
                }
                loadMessages();
            })
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'chat_codes' }, () => {
                syncConfigs();
            })
            .subscribe();

        // Initial Data Fetch
        syncConfigs(); 
        loadMessages(); 
        updateCounter(); 
        
        // Start Background PiP Rendering
        setInterval(drawPiP, 250);
    }

    /**
     * Synchronizes local UI state with Database (Themes, PFPs, Status).
     */
    async function syncConfigs() {
        const { data, error } = await _db.from('chat_codes').select('*');
        if (error) return console.error("Sync Error:", error);

        myData = data.find(u => u.username === me);
        partnerData = data.find(u => u.username === you);

        // Apply Global Visuals
        document.body.className = `theme-${myData.current_theme || 'default'}`;
        
        if (myData.custom_bg) { 
            document.body.style.backgroundImage = `url(${myData.custom_bg})`;
            if (myData.current_theme !== 'default') {
                setTheme('default', true); // Ensure text readability
            }
        } else { 
            document.body.style.backgroundImage = 'none';
        }

        // Set Avatars
        const setPfp = (id, url, name) => {
            const el = document.getElementById(id);
            const avatarApi = `https://ui-avatars.com/api/?name=${defaults[name].t}&background=${defaults[name].bg.replace('#','')}&color=${defaults[name].col.replace('#','')}&bold=true&size=256`;
            el.src = url || avatarApi;
        };

        setPfp('my-pfp', myData.pfp_url, me);
        setPfp('header-pfp', partnerData.pfp_url, you);
        
        // Header Updates
        document.getElementById('partner-name').textContent = you;
        document.getElementById('partner-status').textContent = partnerData.status_text || "No status";
        
        // Story Indicator Logic
        const hasStory = partnerData.story_items?.length > 0;
        document.getElementById('status-ring').classList.toggle('hidden', !hasStory);
        
        // Settings Sync (RJ Only)
        if (me === 'RJ') {
            document.getElementById('receipt-toggle').checked = myData.send_read_receipts;
        }
    }

    /**
     * Updates message read status in Database.
     */
    async function markAsRead(msgId = null) {
        if (!myData || !myData.send_read_receipts) return;

        if (!msgId) {
            // Bulk mark all received messages as read
            await _db.from('private_messages')
                .update({ is_read: true })
                .eq('receiver', me)
                .eq('is_read', false);
        } else {
            // Mark specific message
            await _db.from('private_messages')
                .update({ is_read: true })
                .eq('id', msgId);
        }
    }

    /*
       --- MESSAGING ENGINE ---
    */

    async function loadMessages() {
        markAsRead(); // Attempt to clear unreads on load
        
        const { data, error } = await _db.from('private_messages')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(150);

        if (data) {
            allMessages = data.reverse();
            renderMessages(allMessages);
        }
    }

    function renderMessages(msgs) {
        let html = '';
        
        msgs.forEach(m => {
            const isMe = m.sender === me;
            const time = new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const pfpUrl = isMe ? document.getElementById('my-pfp').src : document.getElementById('header-pfp').src;
            
            // Handle Replies
            let replyHtml = '';
            if (m.reply_to) {
                const parent = allMessages.find(x => x.id === m.reply_to);
                const replyContent = parent ? (parent.message || (parent.file_url ? "üì∑ Media" : "Message")) : "Deleted Message";
                replyHtml = `<div class="reply-preview">${replyContent.substring(0, 45)}</div>`;
            }

            // Handle Media
            const urls = m.file_url ? m.file_url.split(',') : [];
            let mediaHtml = urls.map(u => `
                <img src="${u}" class="rounded-2xl mb-2 w-full max-h-96 object-contain bg-white/5 cursor-pointer transition hover:brightness-110" onclick="openStorySingle('${u}')">
            `).join('');
            
            // Read Status UI
            const showChecks = (isMe && partnerData && partnerData.send_read_receipts);
            const checkMark = m.is_read ? '<span class="text-blue-400">‚úì‚úì</span>' : '‚úì';
            const editedTag = m.edited ? '<span class="italic opacity-30 ml-1 text-[8px] uppercase font-black tracking-widest">(edited)</span>' : '';

            html += `
                <div class="msg-wrap ${isMe ? 'row-me' : ''} mb-6">
                    <img src="${pfpUrl}" class="avatar">
                    <div class="bubble ${isMe ? 'me' : 'you'}">
                        ${replyHtml}
                        ${mediaHtml}
                        <div class="whitespace-pre-wrap leading-relaxed">${formatText(m.message || '')}</div>
                        <span class="ts-inside">
                            ${editedTag} ${time} ${showChecks ? checkMark : ''}
                        </span>
                    </div>
                    
                    <div class="absolute -bottom-6 ${isMe ? 'right-12' : 'left-12'} flex gap-4 opacity-0 hover:opacity-100 transition-all duration-300 p-2 bg-black/40 rounded-full backdrop-blur-xl z-10 border border-white/5 shadow-2xl">
                        <span class="text-[8px] text-blue-400 cursor-pointer font-black tracking-widest uppercase px-2" onclick="setReply('${m.id}', '${(m.message || 'Media').replace(/'/g, "\\'")}')">Reply</span>
                        ${isMe ? `
                            <span class="text-[8px] text-yellow-500 cursor-pointer font-black tracking-widest uppercase px-2 border-l border-white/10" onclick="startEdit('${m.id}', '${(m.message || "").replace(/'/g, "\\'")}')">Edit</span>
                            <span class="text-[8px] text-red-500 cursor-pointer font-black tracking-widest uppercase px-2 border-l border-white/10" onclick="deleteMsg('${m.id}')">Delete</span>
                        ` : ''}
                    </div>
                </div>`;
        });

        const container = document.getElementById('messages');
        container.innerHTML = html;
        container.scrollTop = container.scrollHeight;
    }

    /**
     * Converts raw text into interactive links and YouTube embeds.
     */
    function formatText(text) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, (url) => {
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                const id = url.split('v=')[1] || url.split('/').pop();
                const videoId = id.split('&')[0];
                return `
                    <a href="${url}" target="_blank" class="text-[var(--accent)] underline block mb-3 font-semibold">${url}</a>
                    <div class="rounded-xl overflow-hidden shadow-xl border border-white/10 mb-2">
                        <iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen class="h-48 w-full"></iframe>
                    </div>`;
            }
            return `<a href="${url}" target="_blank" class="text-[var(--accent)] underline font-semibold">${url}</a>`;
        });
    }

    /*
       --- CORE ACTIONS & BROADCASTS ---
    */

    function rainPrompt() {
        const isRJ = (me === 'RJ');
        let content;

        if (isRJ) {
            content = prompt("RJ ADMIN RAIN:\nEnter Text, Emoji, or Image URL:");
        } else {
            content = prompt("Enter an emoji to rain:");
        }
        
        if (!content) return;

        const isImg = (content.match(/\.(jpeg|jpg|gif|png|webp)$/i) || content.startsWith('http'));
        const type = isImg ? 'img' : 'text';

        chatChannel.send({ 
            type: 'broadcast', 
            event: 'sync', 
            payload: { action: 'rain', content, type } 
        });
    }

    function triggerRain(content, type) {
        const count = 35;
        for (let i = 0; i < count; i++) {
            setTimeout(() => {
                const el = document.createElement('div');
                el.className = 'rain-item';
                el.style.left = (Math.random() * 95) + 'vw';
                el.style.animationDuration = (Math.random() * 3 + 2.5) + 's';
                
                if (type === 'img') {
                    el.innerHTML = `<img src="${content}" class="w-20 rounded-2xl shadow-2xl border-2 border-white/10 transform rotate-${Math.floor(Math.random()*20)}">`;
                } else {
                    el.innerText = content;
                    el.style.fontSize = (Math.random() * 1.5 + 1.5) + 'rem';
                }
          
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 6000);
            }, i * 180);
        }
    }

    async function setTheme(t, skipBgReset = false) {
        const update = { current_theme: t };
        if (!skipBgReset) update.custom_bg = null;

        await _db.from('chat_codes').update(update).eq('username', me);
        notifySync();
    }

    async function uploadBG(input) {
        const f = input.files[0];
        if (!f) return;

        const n = `bg_${me}_${Date.now()}`;
        await _db.storage.from('chat-files').upload(n, f);
        const { data } = _db.storage.from('chat-files').getPublicUrl(n);
        
        await _db.from('chat_codes')
            .update({ custom_bg: data.publicUrl, current_theme: 'default' })
            .eq('username', me);

        notifySync();
        input.value = '';
    }

    async function uploadPFP(input) {
        const f = input.files[0];
        if (!f) return;

        const fileName = `pfp_${me}`;
        // Upsert to replace existing file
        await _db.storage.from('chat-files').upload(fileName, f, { upsert: true });
        
        const { data } = _db.storage.from('chat-files').getPublicUrl(fileName);
        const timestampUrl = `${data.publicUrl}?t=${Date.now()}`;
        
        await _db.from('chat_codes').update({ pfp_url: timestampUrl }).eq('username', me);
        
        notifySync();
        input.value = '';
    }

    async function toggleReadReceipts(e) {
        await _db.from('chat_codes')
            .update({ send_read_receipts: e.target.checked })
            .eq('username', me);
        notifySync();
    }

    /*
       --- MESSAGE EDITING & DELETION ---
    */

    function startEdit(id, text) {
        editingId = id;
        const input = document.getElementById('msg-input');
        const sendBtn = document.getElementById('send-btn');
        
        input.value = text;
        document.getElementById('edit-box').classList.remove('hidden');
        
        sendBtn.textContent = "SAVE";
        sendBtn.classList.replace('bg-blue-600', 'bg-yellow-600');
        
        cancelReply();
        input.focus();
    }

    function cancelEdit() {
        editingId = null;
        document.getElementById('msg-input').value = "";
        document.getElementById('edit-box').classList.add('hidden');
        
        const sendBtn = document.getElementById('send-btn');
        sendBtn.textContent = "SEND";
        sendBtn.classList.replace('bg-yellow-600', 'bg-blue-600');
    }

    async function deleteMsg(id) {
        if (!confirm("Are you sure you want to delete this message? This action is recorded in the audit logs.")) return;
        
        await _db.from('private_messages').delete().eq('id', id);
        loadMessages();
    }

    /*
       --- STORY & STATUS ENGINE ---
    */

    async function updateStatus() {
        const txt = document.getElementById('status-txt-input').value;
        const files = document.getElementById('status-media-input').files;
        let items = [];

        if (files.length > 0) {
            document.getElementById('sidebar').style.opacity = '0.5';
            
            for (let f of files) {
                const isVid = f.type.startsWith('video');
                const blob = isVid ? f : await compressImage(f);
                
                const fileName = `story_${Date.now()}_${Math.random().toString(36).substr(2,7)}`;
                await _db.storage.from('chat-files').upload(fileName, blob);
                
                const { data } = _db.storage.from('chat-files').getPublicUrl(fileName);
                items.push({ 
                    url: data.publicUrl, 
                    type: isVid ? 'video' : 'image' 
                });
            }
        }

        // 1. Update Profile Status
        await _db.from('chat_codes')
            .update({ status_text: txt, story_items: items })
            .eq('username', me);

        // 2. Persist to Archive
        await _db.from('story_history').insert([{ 
            username: me, 
            status_text: txt, 
            story_items: items 
        }]);

        notifySync();
        closeSidebar();
        
        document.getElementById('sidebar').style.opacity = '1';
        document.getElementById('status-txt-input').value = '';
        document.getElementById('status-media-input').value = '';
    }

    async function clearStatus() {
        if (!confirm("Clear your current story and status?")) return;
        
        await _db.from('chat_codes')
            .update({ status_text: null, story_items: [] })
            .eq('username', me);
            
        notifySync();
    }

    function handleStatusClick() {
        if (!partnerData || !partnerData.story_items?.length) return;
        openStoryViewer(partnerData.story_items, partnerData.status_text);
    }

    function openStoryViewer(items, caption) {
        storyItems = items;
        storyIndex = 0;
        
        document.getElementById('story-caption').textContent = caption || '';
        renderStoryItem();
        document.getElementById('story-overlay').style.display = 'flex';
    }

    function renderStoryItem() {
        const item = storyItems[storyIndex];
        const container = document.getElementById('story-media-container');
        
        // Navigation Logic
        document.getElementById('story-prev').classList.toggle('hidden', storyIndex === 0);
        document.getElementById('story-next').classList.toggle('hidden', storyIndex === storyItems.length - 1);
        
        if (item.type === 'video') {
            container.innerHTML = `<video src="${item.url}" autoplay controls class="max-h-[85vh] max-w-full rounded-2xl shadow-2xl"></video>`;
        } else {
            container.innerHTML = `<img src="${item.url}" class="max-h-[85vh] max-w-full object-contain rounded-2xl shadow-2xl">`;
        }
    }

    function navStory(dir) {
        storyIndex += dir;
        renderStoryItem();
    }

    function closeStory() {
        document.getElementById('story-overlay').style.display = 'none';
        document.getElementById('story-media-container').innerHTML = '';
    }

    function openStorySingle(url) {
        openStoryViewer([{ url, type: 'image' }], '');
    }

    /*
       --- AUDIT LOG VIEWERS ---
    */

    async function viewDeletedLogs() { 
        const { data, error } = await _db.from('deleted_logs')
            .select('*')
            .order('deleted_at', { ascending: false })
            .limit(50);

        if (error) return alert("Logs unavailable.");

        const logRows = data.map(l => `
            <div class="border-b border-white/5 pb-3">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-red-400 font-black text-[10px] uppercase">${l.original_sender}</span>
                    <span class="opacity-30 text-[9px] font-bold">${new Date(l.deleted_at).toLocaleString()}</span>
                </div>
                <div class="text-sm opacity-80">${l.content || 'No text content'}</div>
                ${l.file_url ? `<img src="${l.file_url}" class="h-40 rounded-xl mt-3 border border-white/10">` : ''}
            </div>
        `);

        renderLogModal('logs-modal', 'logs-content', logRows);
    }

    async function viewEditLogs() {
        const { data, error } = await _db.from('private_messages')
            .select('sender, original_message, message, edited_at')
            .eq('edited', true)
            .order('edited_at', { ascending: false })
            .limit(50);

        if (error) return alert("Edit history unavailable.");

        const editRows = data.map(e => `
            <div class="border-b border-white/5 pb-3">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-yellow-500 font-black text-[10px] uppercase">${e.sender}</span>
                    <span class="opacity-30 text-[9px] font-bold">${new Date(e.edited_at).toLocaleString()}</span>
                </div>
                <div class="text-xs opacity-40 line-through mb-1">Was: ${e.original_message}</div>
                <div class="text-sm text-green-400">Now: ${e.message}</div>
            </div>
        `);

        renderLogModal('edits-modal', 'edits-content', editRows);
    }

    async function viewStoryLogs() {
        const { data, error } = await _db.from('story_history')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50);

        if (error) return;

        const html = data.map(s => {
             const itemsStr = encodeURIComponent(JSON.stringify(s.story_items || []));
             const captionStr = encodeURIComponent(s.status_text || '');
             const isMe = s.username === me;

             return `
                <button onclick="openStoryViewer(JSON.parse(decodeURIComponent('${itemsStr}')), decodeURIComponent('${captionStr}'))" class="p-5 bg-white/5 rounded-3xl text-left hover:bg-white/10 transition border border-white/5 group">
                    <div class="font-black text-[10px] uppercase tracking-widest mb-1 ${isMe ? 'text-blue-400' : 'text-pink-400'}">${s.username}</div>
                    <div class="text-[9px] opacity-30 font-bold mb-3">${new Date(s.created_at).toLocaleString()}</div>
                    <div class="truncate text-xs font-medium opacity-70">${s.status_text || (s.story_items?.length + ' Media files')}</div>
                </button>`;
        }).join('');

        renderLogModal('story-history-modal', 'story-history-content', html);
    }

    function renderLogModal(modalId, contentId, content) {
        const container = document.getElementById(contentId);
        if (Array.isArray(content)) {
            container.innerHTML = content.map(h => `
                <div class="p-4 bg-white/5 rounded-3xl text-sm break-words border border-white/5 mb-2">${h}</div>
            `).join('');
        } else {
            container.innerHTML = content;
        }
        document.getElementById(modalId).style.display = 'block';
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    /*
       --- AGORA VIDEO CONFERENCING ---
    */

    async function initCall(videoEnabled) {
        rtc.client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
        document.getElementById('video-grid').style.display = 'flex';
        
        try {
            // Replace "main" with your actual Agora Channel Name
            const APP_ID = "4f6c6c2002784152a8366dec12f1b4c0";
            await rtc.client.join(APP_ID, "main", null, null);
            
            rtc.localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
            
            if (videoEnabled) {
                rtc.localVideoTrack = await AgoraRTC.createCameraVideoTrack();
                rtc.localVideoTrack.play("local-video");
                await rtc.client.publish([rtc.localAudioTrack, rtc.localVideoTrack]);
            } else {
                await rtc.client.publish([rtc.localAudioTrack]);
            }

            rtc.client.on("user-published", async (user, mediaType) => {
                await rtc.client.subscribe(user, mediaType);
                if (mediaType === "video") user.videoTrack.play("remote-video");
                if (mediaType === "audio") user.audioTrack.play();
            });

        } catch (err) {
            console.error("Call Init Error:", err);
            alert("Call failed: " + err.message);
            endCall();
        }
    }

    function toggleMute() { 
        rtc.isMuted = !rtc.isMuted; 
        rtc.localAudioTrack.setEnabled(!rtc.isMuted); 
        document.getElementById('btn-mute').classList.toggle('active', rtc.isMuted);
    }

    function toggleCam() { 
        rtc.isCamOff = !rtc.isCamOff; 
        rtc.localVideoTrack.setEnabled(!rtc.isCamOff); 
        document.getElementById('btn-cam').classList.toggle('active', rtc.isCamOff);
    }

    function endCall() { 
        rtc.localAudioTrack?.close(); 
        rtc.localVideoTrack?.close(); 
        rtc.client?.leave(); 
        document.getElementById('video-grid').style.display = 'none';
    }

    /*
       --- PICTURE-IN-PICTURE (PiP) VIEW ---
    */

    function drawPiP() {
        const canvas = document.getElementById('pip-canvas');
        const ctx = canvas.getContext('2d');
        const style = getComputedStyle(document.body);

        // Render Background
        ctx.fillStyle = style.getPropertyValue('--bg').trim() || '#03050a';
        ctx.fillRect(0, 0, 400, 250);

        // Title
        ctx.fillStyle = style.getPropertyValue('--accent').trim() || '#3b82f6';
        ctx.font = 'bold 22px Inter, Arial';
        ctx.fillText("MidNight Live Feed", 25, 45);

        // Recent Messages (Last 3)
        const recent = allMessages.slice(-3);
        recent.forEach((m, i) => {
            ctx.fillStyle = style.getPropertyValue('--text').trim() || '#ffffff';
            ctx.font = '14px Inter, Arial';
            
            let displayMsg = m.message || (m.file_url ? "[Media Attached]" : "");
            let line = `${m.sender}: ${displayMsg.substring(0, 38)}${displayMsg.length > 38 ? '...' : ''}`;
            
            ctx.fillText(line, 25, 110 + (i * 45));
            
            // Subtle timestamp
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.font = '9px Inter, Arial';
            ctx.fillText(new Date(m.created_at).toLocaleTimeString(), 25, 125 + (i * 45));
        });

        // Feed Bridge
        const videoElement = document.getElementById('pip-src'); 
        if (!videoElement.srcObject) {
            videoElement.srcObject = canvas.captureStream(25);
        }
    }

    async function launchPiP() {
        const v = document.getElementById('pip-src');
        try {
            await v.play();
            if (document.pictureInPictureEnabled) {
                await v.requestPictureInPicture();
            } else {
                alert("PiP is not supported by your browser.");
            }
        } catch (e) {
            console.error(e);
        }
    }

    /*
       --- UTILITY HELPERS ---
    */

    function notifySync() { 
        chatChannel.send({ 
            type: 'broadcast', 
            event: 'sync', 
            payload: { action: 'refresh' } 
        }); 
    }

    function handleSync(payload) { 
        if (payload.action === 'rain') triggerRain(payload.content, payload.type); 
        if (payload.action === 'refresh') syncConfigs();
    }
    
    async function compressImage(file) {
        if (!file.type.startsWith('image') || file.type === 'image/gif') return file;
        
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = e => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    const MAX_SIZE = 1200;
                    if (width > MAX_SIZE || height > MAX_SIZE) {
                        if (width > height) {
                            height *= MAX_SIZE / width;
                            width = MAX_SIZE;
                        } else {
                            width *= MAX_SIZE / height;
                            height = MAX_SIZE;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob(resolve, 'image/jpeg', 0.82);
                };
            };
        });
    }

    function openSidebar() { 
        document.getElementById('sidebar').style.left = '0'; 
        document.getElementById('overlay-bg').classList.remove('hidden'); 
    }

    function closeSidebar() { 
        document.getElementById('sidebar').style.left = '-300px'; 
        document.getElementById('overlay-bg').classList.add('hidden'); 
    }

    function setReply(id, text) { 
        replyId = id; 
        document.getElementById('reply-text').textContent = text; 
        document.getElementById('reply-box').classList.remove('hidden'); 
        cancelEdit(); 
        document.getElementById('msg-input').focus(); 
    }

    function cancelReply() { 
        replyId = null; 
        document.getElementById('reply-box').classList.add('hidden'); 
    }

    function toggleSearch() { 
        const bar = document.getElementById('search-bar');
        bar.classList.toggle('active');
        if (bar.classList.contains('active')) {
            document.getElementById('search-input').focus();
        } else {
            renderMessages(allMessages);
        }
    }

    function handleSearch(query) { 
        if (!query) {
            renderMessages(allMessages);
            return;
        }
        const filtered = allMessages.filter(m => (m.message || '').toLowerCase().includes(query.toLowerCase()));
        renderMessages(filtered);
    }

    function updateCounter() { 
        const start = new Date('2025-11-24'); // Target Date
        const now = new Date();
        const diff = now - start;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        document.getElementById('days-counter').textContent = days + " DAYS TOGETHER";
    }

    function handleFileSelect(input) { 
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = e => { 
                stagedFiles.push({ file, preview: e.target.result }); 
                renderStaging(); 
            };
            reader.readAsDataURL(file);
        });
        input.value = ""; 
    }

    function renderStaging() { 
        const area = document.getElementById('staging-area');
        area.innerHTML = stagedFiles.map((f, i) => `
            <div class="relative aspect-square group">
                <img src="${f.preview}" class="w-full h-full object-cover rounded-2xl border border-white/10 shadow-lg">
                <button onclick="stagedFiles.splice(${i},1);renderStaging()" class="absolute -top-2 -right-2 bg-red-600 rounded-full w-6 h-6 text-[10px] font-black shadow-xl flex items-center justify-center transition hover:scale-110">‚úï</button>
            </div>
        `).join('');
    }

    /*
       --- MAIN MESSAGE SUBMISSION ---
    */

    document.getElementById('chat-form').onsubmit = async (e) => {
        e.preventDefault();
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        
        // --- EDIT SUBMISSION ---
        if (editingId) {
            if (text) {
                await _db.from('private_messages')
                    .update({ message: text })
                    .eq('id', editingId);
                cancelEdit();
            }
            return;
        }

        // --- NEW MESSAGE SUBMISSION ---
        if (!text && stagedFiles.length === 0) return;

        const filesToUpload = [...stagedFiles]; 
        stagedFiles = []; 
        renderStaging();
        input.value = ""; 

        const curReply = replyId; 
        cancelReply();

        let urls = [];
        for (let f of filesToUpload) {
            const compressed = await compressImage(f.file);
            const path = `msg_${Date.now()}_${Math.random().toString(36).substr(2,6)}`;
            
            const { error } = await _db.storage.from('chat-files').upload(path, compressed);
            if (!error) {
                const { data } = _db.storage.from('chat-files').getPublicUrl(path);
                urls.push(data.publicUrl);
            }
        }

        const { error } = await _db.from('private_messages').insert([{ 
            sender: me, 
            receiver: you, 
            message: text, 
            file_url: urls.join(','), 
            reply_to: curReply, 
            is_read: false 
        }]);

        if (error) console.error("Send Error:", error);
    };
    
    // Typing Broadcast
    document.getElementById('msg-input').oninput = (e) => {
        chatChannel.send({ 
            type: 'broadcast', 
            event: 'typing', 
            payload: { text: e.target.value } 
        });
    };

    // Global Initialization Call
    init();

</script>
</body>
</html>
